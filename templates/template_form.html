{% extends "base.html" %}

{% block title %}{% if template %}Edit Template{% else %}Create Template{% endif %} - Teamarr{% endblock %}

{% block content %}
<style>
/* ============================================================================
   TABBED INTERFACE STYLES
   ============================================================================ */
.tabs-container {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border);
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.tab-button {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.2s;
}

.tab-button:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.tab-button.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ============================================================================
   STICKY SIDEBAR PREVIEW
   ============================================================================ */
.form-with-sidebar {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    align-items: start;
}

@media (max-width: 1200px) {
    .form-with-sidebar {
        grid-template-columns: 1fr;
    }
    .preview-sidebar {
        display: none;
    }
}

.preview-sidebar {
    position: sticky;
    top: 1rem;
    margin-top: 5.7rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    max-height: calc(100vh - 7rem);
    overflow-y: auto;
    align-self: start;
}

.preview-sidebar h4 {
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
    font-size: 1rem;
}

.preview-item {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-left: 3px solid var(--success);
    border-radius: 4px;
}

.preview-item strong {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
}

.preview-item span {
    color: var(--text-primary);
    word-wrap: break-word;
    display: block;
}

/* ============================================================================
   INLINE PREVIEWS
   ============================================================================ */
.inline-preview {
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg-tertiary);
    border-left: 3px solid var(--primary);
    border-radius: 4px;
    font-size: 0.9rem;
}

.inline-preview small {
    display: inline-block;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
    margin-right: 0.5rem;
}

.inline-preview span {
    color: var(--text-primary);
    font-style: italic;
}

.inline-preview span:empty::before {
    content: "(empty)";
    color: var(--text-muted);
    font-style: italic;
    opacity: 0.6;
}

/* ============================================================================
   CONDITIONAL DESCRIPTIONS - COLLAPSIBLE CARDS
   ============================================================================ */
.condition-card {
    border: 2px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    overflow: hidden;
    transition: all 0.2s;
}

.condition-card:hover {
    border-color: var(--primary-light, #818cf8);
}

.condition-card-header {
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
}

.condition-card-header:hover {
    background: var(--bg-secondary);
}

.condition-card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.condition-card-name {
    font-weight: 600;
    color: var(--text-primary);
}

.condition-card-summary {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.condition-card-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.condition-card-expand {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    transition: transform 0.2s;
}

.condition-card.expanded .condition-card-expand {
    transform: rotate(180deg);
}

.condition-card-body {
    padding: 1rem;
    display: none;
    border-top: 1px solid var(--border);
}

.condition-card.expanded .condition-card-body {
    display: block;
}

.condition-source-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.condition-source-custom {
    background: var(--primary-light, rgba(99, 102, 241, 0.1));
    color: var(--primary);
}

.condition-source-preset {
    background: var(--success-light, rgba(34, 197, 94, 0.1));
    color: var(--success);
}

/* ============================================================================
   PRESET LIBRARY MODAL
   ============================================================================ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: var(--bg-primary);
    margin: auto;
    padding: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.preset-library-grid {
    display: grid;
    gap: 0.75rem;
}

.preset-item {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.preset-item:hover {
    border-color: var(--primary);
    background: var(--bg-tertiary);
}

.preset-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.preset-item-name {
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
}

.preset-item-actions {
    display: flex;
    gap: 0.5rem;
}

.preset-delete-btn {
    background: var(--danger, #ef4444);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.preset-delete-btn:hover {
    opacity: 0.8;
}

.preset-item-usage {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.preset-item-condition {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.preset-item-template {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
}

/* ============================================================================
   BUTTON STYLES
   ============================================================================ */
.btn-icon {
    padding: 0.5rem;
    min-width: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}

.chip {
    display: inline-block;
    padding: 0.2rem 0.4rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.chip:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ============================================================================
   SUFFIX SELECTOR POPUP
   ============================================================================ */
.suffix-selector-popup {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    overflow: hidden;
}

.suffix-selector-header {
    padding: 0.5rem 0.75rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-primary);
}

.suffix-selector-options {
    display: flex;
    flex-direction: column;
    padding: 0.25rem;
}

.suffix-option {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 0.5rem 0.75rem;
    background: none;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    text-align: left;
}

.suffix-option:hover {
    background: var(--bg-tertiary);
}

.suffix-label {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: var(--primary);
    font-weight: 600;
}

.suffix-desc {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.15rem;
}

/* ============================================================================
   HELP TEXT & INFO BOXES
   ============================================================================ */
.info-box {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid var(--primary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.info-box strong {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--primary);
}

.info-box ul {
    margin: 0.5rem 0 0 1.25rem;
    padding: 0;
    color: var(--text-secondary);
}

.info-box li {
    margin-bottom: 0.25rem;
}

/* ============================================================================
   TYPE SELECTION GATE (New Templates)
   ============================================================================ */
.type-selection-gate {
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 1.5rem;
}

.type-selection-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.type-selection-header h3 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1.25rem;
}

.type-selection-header p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.type-selection-options {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.type-option {
    flex: 1;
    cursor: pointer;
}

.type-option input[type="radio"] {
    display: none;
}

.type-option-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border);
    border-radius: 8px;
    transition: all 0.2s;
}

.type-option:hover .type-option-content {
    border-color: var(--primary);
    background: var(--bg-secondary);
}

.type-option input[type="radio"]:checked + .type-option-content {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

.type-option-icon {
    font-size: 2rem;
    line-height: 1;
}

.type-option-info {
    flex: 1;
}

.type-option-info strong {
    display: block;
    font-size: 1rem;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.type-option-info span {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.4;
}

.type-selection-footer {
    text-align: center;
}

.type-selection-footer .btn {
    min-width: 200px;
    padding: 0.75rem 2rem;
    font-size: 1rem;
}

/* ============================================================================
   TYPE BADGE (Existing Templates)
   ============================================================================ */
.type-badge-container {
    margin-bottom: 1.5rem;
}

.type-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.type-badge-team {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.3);
}

.type-badge-event {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}

.type-badge-icon {
    font-size: 1.5rem;
}

.type-badge-info {
    flex: 1;
}

.type-badge-info strong {
    display: block;
    font-size: 0.95rem;
    color: var(--text-primary);
}

.type-badge-info span {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.type-badge-locked {
    font-size: 0.75rem;
    color: var(--text-muted);
    padding: 0.25rem 0.5rem;
    background: var(--bg-tertiary);
    border-radius: 4px;
}
</style>

<div class="card">
    <div class="card-header">
        <h2>{% if template %}Edit Template: {{ template.name }}{% else %}Create New Template{% endif %}</h2>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('templates_list') }}" class="btn btn-secondary">‚Üê Back</a>
        </div>
    </div>

    <form method="POST" id="template-form">
        {% if template %}
        <!-- EXISTING TEMPLATE: Show immutable type badge -->
        <div class="type-badge-container">
            <input type="hidden" name="template_type" value="{{ template.template_type or 'team' }}">
            {% if template.template_type == 'event' %}
                <div class="type-badge type-badge-event">
                    <span class="type-badge-icon">üì∫</span>
                    <div class="type-badge-info">
                        <strong>Event Template</strong>
                        <span>For event-based groups (Dispatcharr M3U streams)</span>
                    </div>
                    <span class="type-badge-locked">üîí Locked</span>
                </div>
            {% else %}
                <div class="type-badge type-badge-team">
                    <span class="type-badge-icon">üë§</span>
                    <div class="type-badge-info">
                        <strong>Team Template</strong>
                        <span>For individual teams</span>
                    </div>
                    <span class="type-badge-locked">üîí Locked</span>
                </div>
            {% endif %}
        </div>
        {% else %}
        <!-- NEW TEMPLATE: Type selection gate -->
        <div id="type-selection-gate" class="type-selection-gate">
            <div class="type-selection-header">
                <h3>Step 1: Choose Template Type</h3>
                <p>This determines what fields are available and cannot be changed later.</p>
            </div>
            <div class="type-selection-options">
                <label class="type-option" data-type="team">
                    <input type="radio" name="template_type" value="team" checked>
                    <div class="type-option-content">
                        <span class="type-option-icon">üë§</span>
                        <div class="type-option-info">
                            <strong>Team Template</strong>
                            <span>For individual teams - generates pregame, game, postgame, and idle programs based on team schedules</span>
                        </div>
                    </div>
                </label>
                <label class="type-option" data-type="event">
                    <input type="radio" name="template_type" value="event">
                    <div class="type-option-content">
                        <span class="type-option-icon">üì∫</span>
                        <div class="type-option-info">
                            <strong>Event Template</strong>
                            <span>For Dispatcharr M3U groups - matches streams like "Giants @ Cowboys" to ESPN events</span>
                        </div>
                    </div>
                </label>
            </div>
            <div class="type-selection-footer">
                <button type="button" class="btn btn-primary" onclick="confirmTemplateType()">Continue ‚Üí</button>
            </div>
        </div>
        {% endif %}

        <div class="form-with-sidebar" id="main-form-content" {% if not template %}style="display: none;"{% endif %}>
            <!-- MAIN FORM CONTENT -->
            <div>
                <!-- Tabbed Navigation -->
                <div class="tabs-container">
                    <button type="button" class="tab-button active" data-tab="basic">üìã Basic Info</button>
                    <button type="button" class="tab-button" data-tab="templates">‚úèÔ∏è Defaults</button>
                    <button type="button" class="tab-button" data-tab="conditions">üéØ Conditions</button>
                    <button type="button" class="tab-button" data-tab="fillers">üìÖ Fillers</button>
                    <button type="button" class="tab-button" data-tab="xmltv">‚öôÔ∏è Other EPG Options</button>
                </div>

                <!-- TAB 1: BASIC INFO -->
                <div class="tab-content active" id="tab-basic">
                    <!-- Name Subsection -->
                    <fieldset>
                        <legend><h3>Template Name</h3></legend>
                        <div class="form-group">
                            <label for="name">Name *</label>
                            <input type="text" name="name" id="name" value="{{ template.name if template else '' }}" required placeholder="e.g., NFL Default, NBA Premium">
                        </div>
                    </fieldset>

                    <!-- Event Duration Subsection -->
                    <fieldset style="margin-top: 2rem;">
                        <legend><h3>Event Duration</h3></legend>
                        <div class="form-group">
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Global and Per-Sport Defaults can be changed in Settings</p>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="game_duration_mode" value="sport"
                                           {% if not template or not template.game_duration_mode or template.game_duration_mode == 'sport' %}checked{% endif %}
                                           onchange="updateGameDurationMode()">
                                    <span>Use Per-Sport Default</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="game_duration_mode" value="default"
                                           {% if template and template.game_duration_mode == 'default' %}checked{% endif %}
                                           onchange="updateGameDurationMode()">
                                    <span>Use Global Default</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="game_duration_mode" value="custom"
                                           {% if template and template.game_duration_mode == 'custom' %}checked{% endif %}
                                           onchange="updateGameDurationMode()">
                                    <span>Custom:</span>
                                    <input type="number" name="game_duration_override" id="game_duration_override"
                                           step="0.25" min="1" max="8"
                                           value="{{ template.game_duration_override if template and template.game_duration_override else '' }}"
                                           placeholder="e.g., 3.5"
                                           {% if not template or template.game_duration_mode != 'custom' %}disabled{% endif %}
                                           style="width: 100px;">
                                    <span>hours</span>
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 2: DEFAULTS -->
                <div class="tab-content" id="tab-templates">
                    <!-- Channel Name & Logo Fieldset (Event templates only - shown at top) -->
                    <fieldset id="channel-logo-section" style="display: none;">
                        <legend><h3>Channel Name & Logo</h3></legend>

                        <div class="form-group">
                            <label for="channel_name">Channel Name Template</label>
                            <input type="text" name="channel_name" id="channel_name" class="template-field" placeholder="e.g., {away_team} @ {home_team}" value="{{ template.channel_name if template and template.channel_name else '{away_team} @ {home_team}' }}">
                            <small class="help-text">Name for auto-created Dispatcharr channels. Variables: {home_team}, {away_team}, {league}, {sport}, {event_date}</small>
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-channel-name"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="channel_logo_url">Channel Logo URL Template</label>
                            <input type="text" name="channel_logo_url" id="channel_logo_url"
                                   value="{{ template.channel_logo_url if template and template.channel_logo_url else '' }}"
                                   placeholder="Optional. Leave blank to use default logo."
                                   class="template-field"
                                   style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>

                    <!-- Title & Subtitle Fieldset -->
                    <fieldset id="title-subtitle-section" style="margin-top: 1.5rem;">
                        <legend><h3>Title & Subtitle</h3></legend>

                        <div class="form-group">
                            <label for="title_format">Program Title Template *</label>
                            <input type="text" name="title_format" id="title_format" value="{{ template.title_format if template else '{league} {sport}' }}" required class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-title">Detroit Pistons Basketball</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="subtitle_template">Program Subtitle Template</label>
                            <input type="text" name="subtitle_template" id="subtitle_template" value="{{ template.subtitle_template if template else '{away_team} at {home_team}' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-subtitle">Kia Center, Orlando</span>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Event Program Art Fieldset (Event templates only - after Title & Subtitle) -->
                    <fieldset id="event-program-art-section" style="display: none; margin-top: 1.5rem;">
                        <legend><h3>Program Art</h3></legend>

                        <div class="form-group">
                            <label for="program_art_url_event">Program Art URL Template</label>
                            <input type="text" name="program_art_url" id="program_art_url_event"
                                   value="{{ template.program_art_url if template and template.program_art_url else '' }}"
                                   placeholder="Optional. Leave blank to disable program art."
                                   class="template-field"
                                   style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>

                    <!-- Program Art Fieldset (Team templates only) -->
                    <fieldset id="program-art-section" style="margin-top: 1.5rem;">
                        <legend><h3>Program Art</h3></legend>

                        <div class="form-group">
                            <label for="program_art_url">Program Art URL Template</label>
                            <input type="text" name="program_art_url" id="program_art_url"
                                   value="{{ template.program_art_url if template and template.program_art_url else '' }}"
                                   placeholder="Optional. Leave blank to disable program art."
                                   class="template-field"
                                   style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>

                    <!-- Default Description Templates Fieldset (Team templates - multiple with randomization) -->
                    <fieldset id="team-description-section" style="margin-top: 1.5rem;">
                        <legend><h3>Default Description Templates</h3></legend>

                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Fallback descriptions used when no conditions match (Priority 100). Multiple fallbacks will be randomized.
                        </p>

                        <!-- Fallback Descriptions List -->
                        <div id="fallback-descriptions-container">
                            <!-- Dynamically populated via JavaScript -->
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="addFallbackDescription()" style="margin-top: 0.5rem;">
                            + Add Additional Default Description
                        </button>

                        <!-- Hidden counter for form submission -->
                        <input type="hidden" id="fallback-count" name="fallback_count" value="0">
                    </fieldset>

                    <!-- Hidden fields for JSON data (populated on submit) - OUTSIDE section divs so always submitted -->
                    <input type="hidden" id="description_options_field" name="description_options" value="[]">
                    <input type="hidden" id="flags_field" name="flags" value="{}">
                    <input type="hidden" id="categories_field" name="categories" value="[]">

                    <!-- Simple Description Field (Event templates - single description only) -->
                    <fieldset id="event-description-section" style="margin-top: 1.5rem; display: none;">
                        <legend><h3>Event Description</h3></legend>

                        <div class="form-group">
                            <label for="event_description">Program Description</label>
                            <input type="text" name="event_description" id="event_description" class="template-field" placeholder="e.g., {away_team} vs {home_team} - {league} {sport}" value="">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-event-description"></span>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 3: CONDITIONAL DESCRIPTIONS -->
                <div class="tab-content" id="tab-conditions">
                    <fieldset>
                        <legend><h3>üéØ Conditional Descriptions</h3></legend>

                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            Create dynamic descriptions based on specific conditions. Lower priority numbers are checked and matched first. If no matches, default descriptions are used. If multiple matches at the same priority, one will be selected at random.
                        </p>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-primary" onclick="conditionsAddNew()">+ Add Condition</button>
                            <button type="button" class="btn btn-secondary" onclick="showPresetLibrary()">üìö Preset Library</button>
                        </div>

                        <div id="conditions-list">
                            <!-- Conditions will be rendered here by JavaScript -->
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 4: FILLER PROGRAMS -->
                <div class="tab-content" id="tab-fillers">
                    <!-- Pregame -->
                    <fieldset>
                        <legend><h3>‚è∞ Pregame</h3></legend>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="pregame_enabled" id="pregame_enabled" {% if not template or template.pregame_enabled %}checked{% endif %}>
                                Enable Pregame EPG Entries
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="pregame_title">Title</label>
                            <input type="text" name="pregame_title" id="pregame_title" value="{{ template.pregame_title if template else 'Coming up: {league} {sport} starting at {game_time.next}' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-pregame-title">Pregame Coverage</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pregame_subtitle">Subtitle</label>
                            <input type="text" name="pregame_subtitle" id="pregame_subtitle" value="{{ template.pregame_subtitle if template else '{away_team} at {home_team}' }}" placeholder="Optional" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-pregame-subtitle"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pregame_description">Description</label>
                            <input type="text" name="pregame_description" id="pregame_description" value="{{ template.pregame_description if template else 'The {away_team_record.next} {away_team.next} travel to {venue_city}, {venue_state} to play the {home_team_record.next} {home_team.next} today at {game_time.next}.' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-pregame-description">Pistons play Magic today at 7:00 PM EST</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pregame_art_url">Program Art URL</label>
                            <input type="text" name="pregame_art_url" id="pregame_art_url" value="{{ template.pregame_art_url if template and template.pregame_art_url else '' }}" placeholder="Optional. Leave blank to disable program art." class="template-field" style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>

                    <!-- Postgame -->
                    <fieldset style="margin-top: 1.5rem;">
                        <legend><h3>üì∫ Postgame</h3></legend>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="postgame_enabled" id="postgame_enabled" {% if not template or template.postgame_enabled %}checked{% endif %}>
                                Enable Postgame EPG Entries
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="postgame_title">Title</label>
                            <input type="text" name="postgame_title" id="postgame_title" value="{{ template.postgame_title if template else '{league} {sport}: {team_name} Postgame Recap' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-postgame-title">Postgame Recap</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postgame_subtitle">Subtitle</label>
                            <input type="text" name="postgame_subtitle" id="postgame_subtitle" value="{{ template.postgame_subtitle if template else '{away_team.last} at {home_team.last}' }}" placeholder="Optional" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-postgame-subtitle"></span>
                            </div>
                        </div>
                        <div class="form-group" id="postgame-description-group">
                            <label for="postgame_description">Description</label>
                            <input type="text" name="postgame_description" id="postgame_description" value="{{ template.postgame_description if template else '{team_name} {result_text.last} the {opponent.last} {final_score.last} {overtime_text.last}' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-postgame-description">Pistons defeated Heat 125-124</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="checkbox" name="postgame_conditional_enabled" id="postgame_conditional_enabled"
                                       {% if not template or template.postgame_conditional_enabled %}checked{% endif %}
                                       onchange="togglePostgameConditional()">
                                <span>Use conditional description based on last game status</span>
                            </label>
                            <div id="postgame-conditional-fields" style="{% if template and not template.postgame_conditional_enabled %}display: none;{% endif %}">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="postgame_description_final" style="font-size: 0.85rem; color: var(--success);">‚úì If last game is final:</label>
                                    <input type="text" name="postgame_description_final" id="postgame_description_final"
                                           value="{{ template.postgame_description_final if template else 'The {team_name} {result_text.last} the {opponent.last} {final_score.last} {overtime_text.last}' }}"
                                           class="template-field" placeholder="The {team_name} {result_text.last} the {opponent.last} {final_score.last}"
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-postgame-description-final"></span>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="postgame_description_not_final" style="font-size: 0.85rem; color: var(--warning);">‚è≥ If last game is NOT final:</label>
                                    <input type="text" name="postgame_description_not_final" id="postgame_description_not_final"
                                           value="{{ template.postgame_description_not_final if template else 'The game between the {team_name} and the {opponent.last} on {game_date.last} has not yet ended as of the last update.' }}"
                                           class="template-field" placeholder="The game between {team_name} and {opponent.last} has not yet ended."
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-postgame-description-not-final"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="postgame_art_url">Program Art URL</label>
                            <input type="text" name="postgame_art_url" id="postgame_art_url" value="{{ template.postgame_art_url if template and template.postgame_art_url else '' }}" placeholder="Optional. Leave blank to disable program art." class="template-field" style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>

                    <!-- Idle Day (hidden for event templates) -->
                    <fieldset id="idle-day-section" style="margin-top: 1.5rem;">
                        <legend><h3>üí§ Idle Day</h3></legend>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="idle_enabled" id="idle_enabled" {% if not template or template.idle_enabled %}checked{% endif %}>
                                Enable Idle Day EPG Entries
                            </label>
                        </div>
                        <div class="form-group" id="idle-title-group">
                            <label for="idle_title">Title</label>
                            <input type="text" name="idle_title" id="idle_title" value="{{ template.idle_title if template else 'No {team_name} Game Today' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-idle-title">Pistons Programming</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="checkbox" name="idle_title_offseason_enabled" id="idle_title_offseason_enabled"
                                       {% if template and template.idle_title_offseason_enabled %}checked{% endif %}
                                       onchange="toggleIdleTitleOffseason()">
                                <span>Use conditional title when no games in 30-day lookahead</span>
                            </label>
                            <div id="idle-title-offseason-fields" style="{% if not template or not template.idle_title_offseason_enabled %}display: none;{% endif %}">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="idle_title_offseason" style="font-size: 0.85rem; color: var(--muted);">üìÖ No upcoming games:</label>
                                    <input type="text" name="idle_title_offseason" id="idle_title_offseason"
                                           value="{{ template.idle_title_offseason if template and template.idle_title_offseason else '' }}"
                                           class="template-field" placeholder="Optional title when no upcoming games"
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-idle-title-offseason"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="idle-subtitle-group">
                            <label for="idle_subtitle">Subtitle</label>
                            <input type="text" name="idle_subtitle" id="idle_subtitle" value="{{ template.idle_subtitle if template else 'Next game: {game_date.next} at {game_time.next} {vs_at.next} the {opponent.next}' }}" placeholder="Optional" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-idle-subtitle"></span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="checkbox" name="idle_subtitle_offseason_enabled" id="idle_subtitle_offseason_enabled"
                                       {% if template and template.idle_subtitle_offseason_enabled %}checked{% endif %}
                                       onchange="toggleIdleSubtitleOffseason()">
                                <span>Use conditional subtitle when no games in 30-day lookahead</span>
                            </label>
                            <div id="idle-subtitle-offseason-fields" style="{% if not template or not template.idle_subtitle_offseason_enabled %}display: none;{% endif %}">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="idle_subtitle_offseason" style="font-size: 0.85rem; color: var(--muted);">üìÖ No upcoming games:</label>
                                    <input type="text" name="idle_subtitle_offseason" id="idle_subtitle_offseason"
                                           value="{{ template.idle_subtitle_offseason if template and template.idle_subtitle_offseason else '' }}"
                                           class="template-field" placeholder="Optional subtitle when no upcoming games"
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-idle-subtitle-offseason"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="idle-description-group">
                            <label for="idle_description">Description</label>
                            <input type="text" name="idle_description" id="idle_description" value="{{ template.idle_description if template else 'Next game: {game_date.next} at {game_time.next} vs {opponent.next}' }}" class="template-field">
                            <div class="inline-preview">
                                <small>Preview:</small>
                                <span id="preview-idle-description">Next game: November 25 at 7:00 PM vs LA Clippers</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="checkbox" name="idle_offseason_enabled" id="idle_offseason_enabled"
                                       {% if template and template.idle_offseason_enabled %}checked{% endif %}
                                       onchange="toggleIdleDescriptionOffseason()">
                                <span>Use conditional description when no games in 30-day lookahead</span>
                            </label>
                            <div id="idle-description-offseason-fields" style="{% if not template or not template.idle_offseason_enabled %}display: none;{% endif %}">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="idle_description_offseason" style="font-size: 0.85rem; color: var(--muted);">üìÖ No upcoming games:</label>
                                    <input type="text" name="idle_description_offseason" id="idle_description_offseason"
                                           value="{{ template.idle_description_offseason if template and template.idle_description_offseason else 'No upcoming {team_name} games scheduled.' }}"
                                           class="template-field" placeholder="No upcoming {team_name} games scheduled."
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-idle-description-offseason"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <input type="checkbox" name="idle_conditional_enabled" id="idle_conditional_enabled"
                                       {% if not template or template.idle_conditional_enabled %}checked{% endif %}
                                       onchange="toggleIdleConditional()">
                                <span>Use conditional description based on last game status</span>
                            </label>
                            <div id="idle-conditional-fields" style="{% if template and not template.idle_conditional_enabled %}display: none;{% endif %}">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="idle_description_final" style="font-size: 0.85rem; color: var(--success);">‚úì If last game is final:</label>
                                    <input type="text" name="idle_description_final" id="idle_description_final"
                                           value="{{ template.idle_description_final if template else 'The {team_name} {result_text.last} the {opponent.last} on {game_date.last} {final_score.last} {overtime_text.last}' }}"
                                           class="template-field" placeholder="The {team_name} {result_text.last} {opponent.last}. Next: {opponent.next}"
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-idle-description-final"></span>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="idle_description_not_final" style="font-size: 0.85rem; color: var(--warning);">‚è≥ If last game is NOT final:</label>
                                    <input type="text" name="idle_description_not_final" id="idle_description_not_final"
                                           value="{{ template.idle_description_not_final if template else 'The {team_name} last played against the {opponent.last} on {game_date.last}.' }}"
                                           class="template-field" placeholder="Last played {opponent.last}. Next: {opponent.next}"
                                           style="border: 1px solid var(--border); background: var(--bg-secondary);">
                                    <div class="inline-preview">
                                        <small>Preview:</small>
                                        <span id="preview-idle-description-not-final"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="idle_art_url">Program Art URL</label>
                            <input type="text" name="idle_art_url" id="idle_art_url" value="{{ template.idle_art_url if template and template.idle_art_url else '' }}" placeholder="Optional. Leave blank to disable program art." class="template-field" style="font-family: monospace; font-size: 0.9rem;">
                            <small class="help-text">Optional. Static URL or template with variables. For dynamic art, use <a href="https://github.com/sethwv/game-thumbs" target="_blank" style="color: var(--accent);">game-thumbs</a>.</small>
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 5: OTHER EPG OPTIONS -->
                <div class="tab-content" id="tab-xmltv">
                    <!-- Categories -->
                    <fieldset>
                        <legend><h3>üìÇ Categories</h3></legend>

                        <div class="form-group">
                            <label>Common Categories</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="category_sports" id="category_sports"
                                           {% if not template or (template and template.categories and 'Sports' in template.categories) %}checked{% endif %}>
                                    <span>Sports</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="category_sport_variable" id="category_sport_variable"
                                           {% if not template or (template and template.categories and '{sport}' in template.categories) %}checked{% endif %}>
                                    <span><code>{sport}</code> - Auto-populates with team's sport (Basketball, Football, etc.)</span>
                                </label>
                            </div>
                            <label for="categories_custom" style="font-weight: normal; margin-top: 0.5rem;">Custom Categories (comma-separated)</label>
                            <input type="text" name="categories_custom" id="categories_custom"
                                   value="{{ (template.categories | reject('in', ['Sports', '{sport}']) | join(', ')) if template and template.categories is not none else '' }}"
                                   placeholder="e.g., Entertainment, Live Events">
                            <small class="help-text">Categories shown in EPG guide. Check common ones above or add custom categories.</small>
                        </div>

                        <div class="form-group">
                            <label for="categories_apply_to">Apply Categories To</label>
                            <select name="categories_apply_to" id="categories_apply_to">
                                <option value="all" {% if not template or template.categories_apply_to == 'all' %}selected{% endif %}>All Programs (Events + Filler)</option>
                                <option value="events" {% if template and template.categories_apply_to == 'events' %}selected{% endif %}>Events Only</option>
                            </select>
                            <small class="help-text">Choose whether categories apply to all programs or only game events</small>
                        </div>
                    </fieldset>

                    <!-- Tags -->
                    <fieldset style="margin-top: 1.5rem;">
                        <legend><h3>üè∑Ô∏è Tags</h3></legend>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_new_tag" {% if not template or (template and template.flags and template.flags.new) %}checked{% endif %}>
                                Include New Tag
                            </label>
                            <small class="help-text">Adds &lt;new/&gt; tag to scheduled game events</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_live_tag" {% if not template or (template and template.flags and template.flags.live) %}checked{% endif %}>
                                Include Live Tag
                            </label>
                            <small class="help-text">Adds &lt;live/&gt; tag to scheduled game events</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_date_tag" {% if not template or (template and template.flags and template.flags.date) %}checked{% endif %}>
                                Include Date Tag
                            </label>
                            <small class="help-text">Adds &lt;date&gt; tag with program air date in YYYYMMDD format</small>
                        </div>
                    </fieldset>
                </div>

                <!-- Form Actions -->
                <div class="form-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-success">üíæ Save Template</button>
                    <a href="{{ url_for('templates_list') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </div>

            <!-- STICKY SIDEBAR - VARIABLE HELPER -->
            <div class="preview-sidebar">
                <div id="sidebar-variable-helper"></div>
            </div>
        </div>
    </form>
</div>

<!-- PRESET LIBRARY MODAL -->
<div id="presetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìö Condition Preset Library</h3>
            <button type="button" class="modal-close" onclick="closePresetModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-top: 0; color: var(--text-muted); font-size: 0.9rem;">
                Click a preset to add it to your conditions. You can modify and save your own presets below.
            </p>
            <div id="preset-library-list" class="preset-library-grid">
                <!-- Presets will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePresetModal()">Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
let allDescriptions = {{ description_options_json | default('[]') | safe }};
let conditions = [];  // Conditional descriptions (priority 1-99)
let fallbacks = [];   // Fallback descriptions (priority 100)
let TEMPLATE_VARIABLES = {};
let sampleDataFromAPI = {};  // All examples by sport: { varName: { NBA: 'value', NFL: 'value', ... } }
let availableSports = ['NBA', 'NFL', 'MLB', 'NHL', 'NCAAM', 'NCAAF', 'Soccer'];
let currentPreviewSport = 'NBA';  // Default sport for preview
let recentlyUsedVars = [];
let lastTemplateField = null;

// Template type filtering
let currentTemplateType = '{{ template.template_type if template else 'team' }}';  // 'team' or 'event'
let variableContextMap = {};  // Map of varName -> ['team', 'event'] contexts

// Note: Suffix strategies are now loaded from variables.json via API
// No more hardcoded arrays - everything uses window.variableSuffixMap

// Sample data for preview - dynamically populated based on selected sport
let sampleData = {};

// Get sample data for a specific sport from API data
function getSampleDataForSport(sport) {
    const data = {};
    for (const [varName, sportExamples] of Object.entries(sampleDataFromAPI)) {
        if (sportExamples && typeof sportExamples === 'object') {
            // Use the sport-specific value, fallback to first available
            data[varName] = sportExamples[sport] || Object.values(sportExamples)[0] || '';
        } else {
            // Legacy format: single example value
            data[varName] = sportExamples || '';
        }
    }
    return data;
}

// Update sample data when sport changes
function updatePreviewSport(sport) {
    currentPreviewSport = sport;
    sampleData = getSampleDataForSport(sport);
    updatePreviews();
}

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize tabs immediately (don't wait for API)
    initTabs();

    // Load variables from API first
    try {
        await loadVariablesFromAPI();
        // sampleData is now populated for currentPreviewSport in loadVariablesFromAPI()
    } catch (error) {
        console.error('Failed to load variables:', error);
    }

    // Initialize remaining UI components (after variables load)
    initTemplateVariables();
    initTemplatePreview();
    initFallbackDescriptions();
    initEventDescription();  // Populate event description for event templates
    conditionsRender();

    // Load recently used variables
    loadRecentlyUsed();

    // Update previews on input
    document.querySelectorAll('.template-field').forEach(field => {
        field.addEventListener('input', updatePreviews);
        field.addEventListener('focus', function() {
            lastTemplateField = this;
        });
    });

    // Initialize conditional toggle states on page load
    togglePostgameConditional();
    toggleIdleSubtitleOffseason();
    toggleIdleDescriptionOffseason();
    toggleIdleConditional();

    // Apply template type visibility (hide conditions tab and idle section for event templates)
    updateTemplateTypeDefaults();
});

// ============================================================================
// TABBED INTERFACE
// ============================================================================
function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = this.dataset.tab;

            // Remove active class from all
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked
            this.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });
}

// ============================================================================
// GAME DURATION MODE TOGGLES
// ============================================================================
function updateGameDurationMode() {
    const customRadio = document.querySelector('input[name="game_duration_mode"][value="custom"]');
    const input = document.getElementById('game_duration_override');

    if (customRadio && customRadio.checked) {
        input.disabled = false;
        input.focus();
    } else {
        input.disabled = true;
    }
}

// ============================================================================
// CONDITIONAL FILLER TOGGLES
// ============================================================================
function togglePostgameConditional() {
    const checkbox = document.getElementById('postgame_conditional_enabled');
    const fields = document.getElementById('postgame-conditional-fields');
    const mainDescGroup = document.getElementById('postgame-description-group');
    const mainDescInput = document.getElementById('postgame_description');

    fields.style.display = checkbox.checked ? 'block' : 'none';

    // Grey out and disable main description when conditional is enabled
    if (checkbox.checked) {
        mainDescGroup.style.opacity = '0.5';
        mainDescInput.disabled = true;
        mainDescInput.style.backgroundColor = 'var(--bg-tertiary)';
    } else {
        mainDescGroup.style.opacity = '1';
        mainDescInput.disabled = false;
        mainDescInput.style.backgroundColor = '';
    }

    updatePreviews();
}

function toggleIdleTitleOffseason() {
    const checkbox = document.getElementById('idle_title_offseason_enabled');
    const fields = document.getElementById('idle-title-offseason-fields');

    fields.style.display = checkbox.checked ? 'block' : 'none';
    updatePreviews();
}

function toggleIdleSubtitleOffseason() {
    const checkbox = document.getElementById('idle_subtitle_offseason_enabled');
    const fields = document.getElementById('idle-subtitle-offseason-fields');

    fields.style.display = checkbox.checked ? 'block' : 'none';
    updatePreviews();
}

function toggleIdleDescriptionOffseason() {
    const checkbox = document.getElementById('idle_offseason_enabled');
    const fields = document.getElementById('idle-description-offseason-fields');

    fields.style.display = checkbox.checked ? 'block' : 'none';
    updatePreviews();
}

function toggleIdleConditional() {
    const checkbox = document.getElementById('idle_conditional_enabled');
    const fields = document.getElementById('idle-conditional-fields');
    const mainDescGroup = document.getElementById('idle-description-group');
    const mainDescInput = document.getElementById('idle_description');

    fields.style.display = checkbox.checked ? 'block' : 'none';

    // Grey out base description ONLY when last game status is enabled
    // (because final/not-final is binary - one must be true, so base is never used)
    // Offseason toggle still needs base as fallback when games exist in lookahead
    if (checkbox.checked) {
        mainDescGroup.style.opacity = '0.5';
        mainDescInput.disabled = true;
        mainDescInput.style.backgroundColor = 'var(--bg-tertiary)';
    } else {
        mainDescGroup.style.opacity = '1';
        mainDescInput.disabled = false;
        mainDescInput.style.backgroundColor = '';
    }

    updatePreviews();
}

// ============================================================================
// TEMPLATE PREVIEW
// ============================================================================
function initTemplatePreview() {
    updatePreviews();
}

function updatePreviews() {
    const title = document.getElementById('title_format')?.value || '';
    const subtitle = document.getElementById('subtitle_template')?.value || '';

    // Get first fallback description for preview (or from first fallback textarea if available)
    const firstFallbackTextarea = document.querySelector('textarea[name^="fallback_template_"]');
    const description = firstFallbackTextarea?.value || (fallbacks[0]?.template) || '';

    const pregameTitle = document.getElementById('pregame_title')?.value || '';
    const pregameSubtitle = document.getElementById('pregame_subtitle')?.value || '';
    const pregameDesc = document.getElementById('pregame_description')?.value || '';
    const postgameTitle = document.getElementById('postgame_title')?.value || '';
    const postgameSubtitle = document.getElementById('postgame_subtitle')?.value || '';
    const postgameDesc = document.getElementById('postgame_description')?.value || '';
    const idleTitle = document.getElementById('idle_title')?.value || '';
    const idleSubtitle = document.getElementById('idle_subtitle')?.value || '';
    const idleDesc = document.getElementById('idle_description')?.value || '';

    // Update inline previews for main program
    const previewTitle = document.getElementById('preview-title');
    if (previewTitle) previewTitle.textContent = replaceVariables(title);

    const previewSubtitle = document.getElementById('preview-subtitle');
    if (previewSubtitle) previewSubtitle.textContent = replaceVariables(subtitle);

    // Update inline previews for pregame
    const previewPregameTitle = document.getElementById('preview-pregame-title');
    if (previewPregameTitle) previewPregameTitle.textContent = replaceVariables(pregameTitle);

    const previewPregameSubtitle = document.getElementById('preview-pregame-subtitle');
    if (previewPregameSubtitle) previewPregameSubtitle.textContent = replaceVariables(pregameSubtitle);

    const previewPregameDesc = document.getElementById('preview-pregame-description');
    if (previewPregameDesc) previewPregameDesc.textContent = replaceVariables(pregameDesc);

    // Update inline previews for postgame
    const previewPostgameTitle = document.getElementById('preview-postgame-title');
    if (previewPostgameTitle) previewPostgameTitle.textContent = replaceVariables(postgameTitle);

    const previewPostgameSubtitle = document.getElementById('preview-postgame-subtitle');
    if (previewPostgameSubtitle) previewPostgameSubtitle.textContent = replaceVariables(postgameSubtitle);

    const previewPostgameDesc = document.getElementById('preview-postgame-description');
    if (previewPostgameDesc) previewPostgameDesc.textContent = replaceVariables(postgameDesc);

    // Update inline previews for idle
    const previewIdleTitle = document.getElementById('preview-idle-title');
    if (previewIdleTitle) previewIdleTitle.textContent = replaceVariables(idleTitle);

    const previewIdleSubtitle = document.getElementById('preview-idle-subtitle');
    if (previewIdleSubtitle) previewIdleSubtitle.textContent = replaceVariables(idleSubtitle);

    const previewIdleDesc = document.getElementById('preview-idle-description');
    if (previewIdleDesc) previewIdleDesc.textContent = replaceVariables(idleDesc);

    // Update inline previews for postgame conditional descriptions
    const postgameDescFinal = document.getElementById('postgame_description_final')?.value || '';
    const postgameDescNotFinal = document.getElementById('postgame_description_not_final')?.value || '';
    const previewPostgameDescFinal = document.getElementById('preview-postgame-description-final');
    if (previewPostgameDescFinal) previewPostgameDescFinal.textContent = replaceVariables(postgameDescFinal);
    const previewPostgameDescNotFinal = document.getElementById('preview-postgame-description-not-final');
    if (previewPostgameDescNotFinal) previewPostgameDescNotFinal.textContent = replaceVariables(postgameDescNotFinal);

    // Update inline previews for idle offseason title, subtitle and description
    const idleTitleOffseason = document.getElementById('idle_title_offseason')?.value || '';
    const previewIdleTitleOffseason = document.getElementById('preview-idle-title-offseason');
    if (previewIdleTitleOffseason) previewIdleTitleOffseason.textContent = replaceVariables(idleTitleOffseason);
    const idleSubtitleOffseason = document.getElementById('idle_subtitle_offseason')?.value || '';
    const previewIdleSubtitleOffseason = document.getElementById('preview-idle-subtitle-offseason');
    if (previewIdleSubtitleOffseason) previewIdleSubtitleOffseason.textContent = replaceVariables(idleSubtitleOffseason);
    const idleDescOffseason = document.getElementById('idle_description_offseason')?.value || '';
    const previewIdleDescOffseason = document.getElementById('preview-idle-description-offseason');
    if (previewIdleDescOffseason) previewIdleDescOffseason.textContent = replaceVariables(idleDescOffseason);

    // Update inline previews for idle conditional descriptions
    const idleDescFinal = document.getElementById('idle_description_final')?.value || '';
    const idleDescNotFinal = document.getElementById('idle_description_not_final')?.value || '';
    const previewIdleDescFinal = document.getElementById('preview-idle-description-final');
    if (previewIdleDescFinal) previewIdleDescFinal.textContent = replaceVariables(idleDescFinal);
    const previewIdleDescNotFinal = document.getElementById('preview-idle-description-not-final');
    if (previewIdleDescNotFinal) previewIdleDescNotFinal.textContent = replaceVariables(idleDescNotFinal);

    // Update inline previews for fallback descriptions
    fallbacks.forEach((fallback, index) => {
        const textarea = document.getElementById(`fallback_template_${index}`);
        const preview = document.getElementById(`preview-fallback-${index}`);
        if (textarea && preview) {
            preview.textContent = replaceVariables(textarea.value);
        }
    });

    // Update inline preview for event description (single description for event templates)
    const eventDesc = document.getElementById('event_description')?.value || '';
    const previewEventDesc = document.getElementById('preview-event-description');
    if (previewEventDesc) previewEventDesc.textContent = replaceVariables(eventDesc);

    // Update inline preview for channel name (event templates)
    const channelName = document.getElementById('channel_name')?.value || '';
    const previewChannelName = document.getElementById('preview-channel-name');
    if (previewChannelName) previewChannelName.textContent = replaceVariables(channelName);

    // Update inline previews for conditional descriptions
    conditions.forEach((condition, index) => {
        const input = document.getElementById(`cond_template_${index}`);
        const preview = document.getElementById(`preview-condition-${index}`);
        if (input && preview) {
            preview.textContent = replaceVariables(input.value);
        }
    });
}

function replaceVariables(template) {
    let result = template;
    for (const [key, value] of Object.entries(sampleData)) {
        // Get available suffixes - check context-specific first, then fall back to default
        const contextSuffixes = window.variableSuffixByContextMap?.[key]?.[currentTemplateType];
        const suffixes = contextSuffixes || window.variableSuffixMap?.[key] || ['base', 'next', 'last'];

        // Replace base variable {var} if base suffix is available
        if (suffixes.includes('base')) {
            result = result.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
        }
        // Replace {var.next} if next suffix is available
        if (suffixes.includes('next')) {
            result = result.replace(new RegExp(`\\{${key}\\.next\\}`, 'g'), value);
        }
        // Replace {var.last} if last suffix is available
        if (suffixes.includes('last')) {
            result = result.replace(new RegExp(`\\{${key}\\.last\\}`, 'g'), value);
        }
    }
    return result;
}

// ============================================================================
// TEMPLATE VARIABLES (Dynamically loaded from /api/variables)
// ============================================================================
async function loadVariablesFromAPI() {
    try {
        const response = await fetch('/api/variables');
        if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();

        // Group variables by category
        const categoryMap = {};
        const sampleMap = {};  // Now stores { varName: { NBA: 'val', NFL: 'val', ... } }
        const suffixMap = {}; // Store suffix availability for each variable
        const suffixByContextMap = {}; // Store context-specific suffix overrides
        const contextMap = {}; // Store context (team/event) for each variable

        data.variables.forEach(variable => {
            if (!categoryMap[variable.category]) {
                categoryMap[variable.category] = {
                    icon: variable.icon,
                    variables: []
                };
            }
            categoryMap[variable.category].variables.push(variable.name);

            // Use examples_by_sport if available, fallback to example for legacy
            if (variable.examples_by_sport) {
                sampleMap[variable.name] = variable.examples_by_sport;
            } else if (variable.example) {
                // Legacy: wrap single example for all sports
                sampleMap[variable.name] = {
                    NBA: variable.example,
                    NFL: variable.example,
                    MLB: variable.example,
                    NHL: variable.example,
                    NCAAM: variable.example,
                    NCAAF: variable.example,
                    Soccer: variable.example
                };
            }

            suffixMap[variable.name] = variable.available_suffixes || ['base', 'next', 'last'];

            // Store context-specific suffixes if available
            if (variable.available_suffixes_by_context) {
                suffixByContextMap[variable.name] = variable.available_suffixes_by_context;
            }

            // Store context for filtering (default to both if not specified)
            contextMap[variable.name] = variable.context || ['team', 'event'];
        });

        // Load available sports from metadata if present
        if (data.examples_by_sport_info?.sports) {
            availableSports = data.examples_by_sport_info.sports;
        }

        TEMPLATE_VARIABLES = categoryMap;
        sampleDataFromAPI = sampleMap;
        window.variableSuffixMap = suffixMap; // Make globally available
        window.variableSuffixByContextMap = suffixByContextMap; // Context-specific suffixes
        variableContextMap = contextMap; // Store for filtering

        // Initialize sampleData for current sport
        sampleData = getSampleDataForSport(currentPreviewSport);

        return true;
    } catch (error) {
        console.error('Failed to load variables from API:', error);
        return false;
    }
}

// ============================================================================
// TEMPLATE TYPE HANDLING
// ============================================================================

function confirmTemplateType() {
    // Get selected type
    const selectedType = document.querySelector('input[name="template_type"]:checked')?.value || 'team';
    currentTemplateType = selectedType;

    // Hide the type selection gate
    const gate = document.getElementById('type-selection-gate');
    if (gate) gate.style.display = 'none';

    // Show the main form
    const mainForm = document.getElementById('main-form-content');
    if (mainForm) mainForm.style.display = '';

    // Apply defaults for the selected type
    updateTemplateTypeDefaults();

    // Focus the name field
    const nameField = document.getElementById('name');
    if (nameField) nameField.focus();
}

// Event template defaults (no suffixes - single-game context)
const EVENT_TEMPLATE_DEFAULTS = {
    'title_format': '{away_team} @ {home_team}',
    'subtitle_template': '{venue}',
    'channel_name': '{away_team} @ {home_team}',
    'pregame_title': '{away_team} @ {home_team} Pregame',
    'pregame_subtitle': '',
    'pregame_description': '{away_team} takes on {home_team} at {game_time}',
    'postgame_title': '{away_team} @ {home_team} Postgame',
    'postgame_subtitle': '',
    'postgame_description': '{winner} defeated {loser}. Final: {event_result_abbrev}',
    'postgame_description_final': 'Game ended: {event_result}',
    'postgame_description_not_final': '{matchup} has not yet ended.',
    'event_description': '{away_team} vs {home_team} - {league} {sport}'
};

// Team template defaults (with suffixes for filler context)
const TEAM_TEMPLATE_DEFAULTS = {
    'title_format': '{team_name} {sport}',
    'subtitle_template': '{venue_full}',
    'pregame_title': 'Coming up: {league} {sport} starting at {game_time.next}',
    'pregame_subtitle': '{away_team.next} at {home_team.next}',
    'pregame_description': 'The {away_team_record.next} {away_team.next} travel to {venue_city}, {venue_state} to play the {home_team_record.next} {home_team.next} today at {game_time.next}.',
    'postgame_title': '{league} {sport}: {team_name} Postgame Recap',
    'postgame_subtitle': '{away_team.last} at {home_team.last}',
    'postgame_description': '{team_name} {result_text.last} the {opponent.last} {final_score.last} {overtime_text.last}',
    'postgame_description_final': 'The {team_name} {result_text.last} the {opponent.last} {final_score.last} {overtime_text.last}',
    'postgame_description_not_final': 'The game between the {team_name} and the {opponent.last} on {game_date.last} has not yet ended as of the last update.',
    'idle_title': 'No {team_name} Game Today',
    'idle_title_offseason': '',
    'idle_subtitle': 'Next game: {game_date.next} at {game_time.next} {vs_at.next} the {opponent.next}',
    'idle_description': 'Next game: {game_date.next} at {game_time.next} vs {opponent.next}',
    'idle_description_offseason': 'No upcoming {team_name} games scheduled.',
    'idle_description_final': 'The {team_name} {result_text.last} the {opponent.last} on {game_date.last} {final_score.last} {overtime_text.last}',
    'idle_description_not_final': 'The {team_name} last played against the {opponent.last} on {game_date.last}.'
};

function applyTemplateDefaults(templateType) {
    const defaults = templateType === 'event' ? EVENT_TEMPLATE_DEFAULTS : TEAM_TEMPLATE_DEFAULTS;
    for (const [fieldId, value] of Object.entries(defaults)) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = value;
        }
    }
}

function updateTemplateTypeDefaults() {
    // Get template type from radio button (new) or hidden input (existing)
    const radioChecked = document.querySelector('input[name="template_type"]:checked');
    const hiddenInput = document.querySelector('input[name="template_type"][type="hidden"]');

    if (radioChecked) {
        currentTemplateType = radioChecked.value;
    } else if (hiddenInput) {
        currentTemplateType = hiddenInput.value;
    } else {
        return;
    }

    // For NEW templates, apply type-specific defaults
    // Only apply if this is a new template (radio buttons visible, not hidden input)
    const isNewTemplate = radioChecked !== null;
    if (isNewTemplate) {
        applyTemplateDefaults(currentTemplateType);
    }

    // Re-render variables sidebar with filtered variables
    initTemplateVariables();

    // Update previews
    updatePreviews();

    // Hide/show sections based on template type
    const conditionsTab = document.querySelector('.tab-button[data-tab="conditions"]');
    const conditionsContent = document.getElementById('tab-conditions');
    const idleDaySection = document.getElementById('idle-day-section');
    const teamDescriptionSection = document.getElementById('team-description-section');
    const eventDescriptionSection = document.getElementById('event-description-section');
    const channelLogoSection = document.getElementById('channel-logo-section');
    const programArtSection = document.getElementById('program-art-section');
    const eventProgramArtSection = document.getElementById('event-program-art-section');
    const titleSubtitleSection = document.getElementById('title-subtitle-section');

    // Get the program_art_url input fields (both have same name, need to disable hidden one)
    const teamProgramArtInput = document.getElementById('program_art_url');
    const eventProgramArtInput = document.getElementById('program_art_url_event');

    if (currentTemplateType === 'event') {
        // Hide Conditions tab for event templates
        if (conditionsTab) conditionsTab.style.display = 'none';
        if (conditionsContent) conditionsContent.style.display = 'none';
        // Hide Idle Day section for event templates
        if (idleDaySection) idleDaySection.style.display = 'none';
        // Hide team description (multiple fallbacks), show event description (single)
        if (teamDescriptionSection) teamDescriptionSection.style.display = 'none';
        if (eventDescriptionSection) eventDescriptionSection.style.display = '';
        // Show Channel Name & Logo section (event only), hide team Program Art section
        if (channelLogoSection) channelLogoSection.style.display = '';
        if (programArtSection) programArtSection.style.display = 'none';
        // Show event-specific Program Art section (after Title & Subtitle)
        if (eventProgramArtSection) eventProgramArtSection.style.display = '';
        // Remove top margin from Title & Subtitle since Channel Name & Logo is now first
        if (titleSubtitleSection) titleSubtitleSection.style.marginTop = '1.5rem';
        // If currently on conditions tab, switch to basic
        if (conditionsTab && conditionsTab.classList.contains('active')) {
            document.querySelector('.tab-button[data-tab="basic"]').click();
        }
        // Disable team program art input (hidden), enable event one
        // This prevents duplicate form field submission
        if (teamProgramArtInput) teamProgramArtInput.disabled = true;
        if (eventProgramArtInput) eventProgramArtInput.disabled = false;
    } else {
        // Show sections for team templates
        if (conditionsTab) conditionsTab.style.display = '';
        if (conditionsContent) conditionsContent.style.display = '';
        if (idleDaySection) idleDaySection.style.display = '';
        // Show team description (multiple fallbacks), hide event description (single)
        if (teamDescriptionSection) teamDescriptionSection.style.display = '';
        if (eventDescriptionSection) eventDescriptionSection.style.display = 'none';
        // Hide Channel Name & Logo section (event only), show team Program Art section
        if (channelLogoSection) channelLogoSection.style.display = 'none';
        if (programArtSection) programArtSection.style.display = '';
        // Hide event-specific Program Art section
        if (eventProgramArtSection) eventProgramArtSection.style.display = 'none';
        // Remove top margin from Title & Subtitle since it's now first
        if (titleSubtitleSection) titleSubtitleSection.style.marginTop = '0';
        // Enable team program art input, disable event one (hidden)
        // This prevents duplicate form field submission
        if (teamProgramArtInput) teamProgramArtInput.disabled = false;
        if (eventProgramArtInput) eventProgramArtInput.disabled = true;
    }
}

// Check if a variable is available for the current template type
function isVariableAvailableForType(varName) {
    const context = variableContextMap[varName];
    if (!context || context.length === 0) {
        // No context specified - available for both
        return true;
    }
    return context.includes(currentTemplateType);
}

function getSuffixClass(variableName) {
  // Get available suffixes from API data
  const suffixes = window.variableSuffixMap?.[variableName] || ['base', 'next', 'last'];

  // Determine CSS class based on available suffixes
  if (suffixes.length === 1) {
    if (suffixes[0] === 'base') return 'var-base';
    if (suffixes[0] === 'last') return 'var-last';
    if (suffixes[0] === 'next') return 'var-next';
  } else if (suffixes.length === 2 && suffixes.includes('base') && suffixes.includes('next')) {
    return 'var-next'; // base+next = odds variables
  } else if (suffixes.length === 3) {
    return 'var-all'; // all three contexts
  }

  return 'var-all'; // default
}

function generateTemplateVariablesHTML(containerId) {
    const baseVarCount = Object.keys(sampleDataFromAPI).length;

    // If no variables loaded, show loading message
    if (Object.keys(TEMPLATE_VARIABLES).length === 0) {
        return '<div class="variable-helper"><p style="color: var(--text-muted); padding: 1rem;">Loading variables...</p></div>';
    }

    // Build sport options
    const sportOptions = availableSports.map(sport =>
        `<option value="${sport}" ${sport === currentPreviewSport ? 'selected' : ''}>${sport}</option>`
    ).join('');

    // Template type indicator
    const typeLabel = currentTemplateType === 'event' ? 'üì∫ Event' : 'üë§ Team';

    let html = `
        <div class="variable-helper">
            <h4 style="margin: 0 0 0.75rem 0; color: var(--text-secondary); font-size: 1rem;">üìù Template Variables</h4>

            <!-- Template Type Indicator -->
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.375rem 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.8rem;">
                <span style="color: var(--text-muted);">Showing vars for:</span>
                <span style="font-weight: 600; color: var(--primary);">${typeLabel}</span>
            </div>

            <!-- Suffix System Guide (team templates only) -->
            ${currentTemplateType === 'team' ? `
            <div class="suffix-guide">
                <ul class="suffix-guide-list">
                    <li><code>{variable}</code> current game OR not game-dependent</li>
                    <li><code>{variable.next}</code> next game</li>
                    <li><code>{variable.last}</code> last game</li>
                </ul>
                <div class="suffix-legend">
                    <span class="suffix-badge badge-all">ALL</span> all contexts ‚Ä¢
                    <span class="suffix-badge badge-base">BASE</span> no suffix ‚Ä¢
                    <span class="suffix-badge badge-next">.next</span> base+.next ‚Ä¢
                    <span class="suffix-badge badge-last">.last</span> .last only
                </div>
            </div>
            ` : `
            <div class="suffix-guide" style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 0.75rem;">
                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Event templates use single-game context. No suffixes needed.</p>
            </div>
            `}

            <!-- Search -->
            <input type="text" class="variable-search-input" placeholder="Search variables..." style="width: 100%; margin-bottom: 0.75rem; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;">

            <!-- Recently Used (collapsible) -->
            <details class="variable-category recently-used-category" style="display: none; margin-bottom: 0.5rem;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary); font-size: 0.85rem; padding: 0.25rem 0;">üïí Recently Used</summary>
                <div class="recently-used-vars" style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.5rem;"></div>
            </details>
    `;

    const categoryCount = Object.keys(TEMPLATE_VARIABLES).length;

    if (categoryCount === 0) {
        html += `<p style="color: orange; margin: 0.5rem 0; font-size: 0.85rem;">‚ö†Ô∏è Loading variables from API...</p>`;
    }

    for (const [categoryName, categoryData] of Object.entries(TEMPLATE_VARIABLES)) {
        // Filter variables by current template type
        const filteredVars = categoryData.variables.filter(varName => isVariableAvailableForType(varName));

        // Skip category if no variables are available for this template type
        if (filteredVars.length === 0) continue;

        html += `
            <details style="margin-bottom: 0.5rem;" class="variable-category">
                <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary); font-size: 0.85rem; padding: 0.25rem 0;">${categoryName}</summary>
                <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.5rem;">
        `;

        // Sort variables alphabetically within category
        const sortedVars = [...filteredVars].sort((a, b) => a.localeCompare(b));

        sortedVars.forEach(varName => {
            const suffixClass = getSuffixClass(varName);
            const suffixes = window.variableSuffixMap?.[varName] || ['base', 'next', 'last'];

            // Determine display name and behavior
            let displayName = varName;
            let clickHandler = '';

            // Event templates: always insert base variable (no suffixes)
            if (currentTemplateType === 'event') {
                displayName = varName;
                clickHandler = `onclick="insertVariable('{${varName}}')"`;
            } else if (suffixes.length === 1) {
                // Single suffix: show it in the display and insert immediately
                if (suffixes[0] === 'last') {
                    displayName = `${varName}.last`;
                    clickHandler = `onclick="insertVariable('{${varName}.last}')"`;
                } else if (suffixes[0] === 'next') {
                    displayName = `${varName}.next`;
                    clickHandler = `onclick="insertVariable('{${varName}.next}')"`;
                } else {
                    // base only - insert directly
                    displayName = varName;
                    clickHandler = `onclick="insertVariable('{${varName}}')"`;
                }
            } else {
                // Multiple suffixes: show popup selector
                clickHandler = `onclick="showSuffixSelector(event, '${varName}')"`;
            }

            // For event templates, use neutral styling (no suffix color coding)
            const chipClass = currentTemplateType === 'event' ? 'var-base' : suffixClass;
            html += `<button type="button" class="chip ${chipClass}" ${clickHandler}>${displayName}</button>`;
        });

        html += `
                </div>
            </details>
        `;
    }

    // Sport Selector for Preview - at the very bottom
    html += `
            <div class="sport-preview-selector" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; border: 1px solid var(--border);">
                <label for="preview-sport-select" style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap;">Preview as:</label>
                <select id="preview-sport-select" onchange="updatePreviewSport(this.value)" style="flex: 1; padding: 0.25rem 0.5rem; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 3px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
                    ${sportOptions}
                </select>
            </div>
    `;

    html += `</div>`;
    return html;
}

function initTemplateVariables() {
    // Initialize single variable helper in sidebar
    const sidebarContainer = document.getElementById('sidebar-variable-helper');
    if (sidebarContainer) {
        sidebarContainer.innerHTML = generateTemplateVariablesHTML('sidebar-variable-helper');
    }

    // Set up search functionality
    document.querySelectorAll('.variable-search-input').forEach(searchInput => {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const parent = e.target.closest('.variable-helper');
            const categories = parent.querySelectorAll('.variable-category');

            categories.forEach(category => {
                if (category.classList.contains('recently-used-category')) return;

                const buttons = category.querySelectorAll('.chip');
                let hasVisibleButtons = false;

                buttons.forEach(button => {
                    const variableName = button.textContent.toLowerCase();
                    if (variableName.includes(searchTerm)) {
                        button.style.display = '';
                        hasVisibleButtons = true;
                    } else {
                        button.style.display = 'none';
                    }
                });

                if (searchTerm && hasVisibleButtons) {
                    category.setAttribute('open', '');
                    category.style.display = '';
                } else if (searchTerm && !hasVisibleButtons) {
                    category.style.display = 'none';
                } else {
                    category.style.display = '';
                    category.removeAttribute('open');
                }
            });
        });
    });

    updateAllRecentlyUsedDisplays();
}

function insertVariable(variable) {
    let targetElement = document.activeElement;

    if (!targetElement || (targetElement.tagName !== 'INPUT' && targetElement.tagName !== 'TEXTAREA')) {
        targetElement = lastTemplateField;
    }

    // Default to first fallback template field if no field is focused
    if (!targetElement) {
        targetElement = document.querySelector('textarea[name^="fallback_template_"]');
    }

    if (targetElement && (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA')) {
        const start = targetElement.selectionStart || 0;
        const end = targetElement.selectionEnd || 0;
        const text = targetElement.value || '';
        const before = text.substring(0, start);
        const after = text.substring(end);
        targetElement.value = before + variable + after;
        targetElement.selectionStart = targetElement.selectionEnd = start + variable.length;
        targetElement.focus();
        lastTemplateField = targetElement;

        addToRecentlyUsed(variable);
        updatePreviews();
    }
}

function showSuffixSelector(event, varName) {
    event.stopPropagation();

    // Look up suffixes for this variable
    const suffixes = window.variableSuffixMap?.[varName] || ['base', 'next', 'last'];

    // Check if popup already exists for this variable
    const existingPopup = document.querySelector('.suffix-selector-popup');
    if (existingPopup) {
        const existingVarName = existingPopup.querySelector('.suffix-selector-header')?.textContent;
        if (existingVarName === varName) {
            // Clicking the same variable - just close the popup
            existingPopup.remove();
            return;
        }
        // Different variable - remove old popup and show new one
        existingPopup.remove();
    }

    // Create popup
    const popup = document.createElement('div');
    popup.className = 'suffix-selector-popup';

    // Position near the clicked button
    const rect = event.target.getBoundingClientRect();
    popup.style.position = 'fixed';
    popup.style.top = `${rect.bottom + 5}px`;
    popup.style.left = `${rect.left}px`;
    popup.style.zIndex = '10000';

    // Build popup content
    const suffixLabels = {
        'base': { label: 'base', desc: 'current game OR not game-dependent' },
        'next': { label: '.next', desc: 'next game' },
        'last': { label: '.last', desc: 'last game' }
    };

    let html = `<div class="suffix-selector-header">${varName}</div>`;
    html += '<div class="suffix-selector-options">';

    suffixes.forEach(suffix => {
        const info = suffixLabels[suffix];
        const varText = suffix === 'base' ? varName : `${varName}.${suffix}`;
        html += `
            <button type="button" class="suffix-option" onclick="selectSuffix('${varName}', '${suffix}')">
                <span class="suffix-label">{${varText}}</span>
                <span class="suffix-desc">${info.desc}</span>
            </button>
        `;
    });

    html += '</div>';
    popup.innerHTML = html;

    document.body.appendChild(popup);

    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', function closePopup(e) {
            if (!popup.contains(e.target)) {
                popup.remove();
                document.removeEventListener('click', closePopup);
            }
        });
    }, 10);
}

function selectSuffix(varName, suffix) {
    // Remove popup
    const popup = document.querySelector('.suffix-selector-popup');
    if (popup) {
        popup.remove();
    }

    // Build variable text
    const varText = suffix === 'base' ? `{${varName}}` : `{${varName}.${suffix}}`;

    // Insert variable
    insertVariable(varText);
}

// ============================================================================
// RECENTLY USED VARIABLES
// ============================================================================
function loadRecentlyUsed() {
    const stored = localStorage.getItem('teamarr_recent_vars');
    if (stored) {
        recentlyUsedVars = JSON.parse(stored);
        updateAllRecentlyUsedDisplays();
    }
}

function addToRecentlyUsed(variable) {
    recentlyUsedVars = recentlyUsedVars.filter(v => v !== variable);
    recentlyUsedVars.unshift(variable);
    recentlyUsedVars = recentlyUsedVars.slice(0, 10);
    localStorage.setItem('teamarr_recent_vars', JSON.stringify(recentlyUsedVars));
    updateAllRecentlyUsedDisplays();
}

function updateAllRecentlyUsedDisplays() {
    const containers = document.querySelectorAll('.recently-used-vars');
    const categories = document.querySelectorAll('.recently-used-category');

    if (recentlyUsedVars.length === 0) {
        categories.forEach(cat => cat.style.display = 'none');
        return;
    }

    categories.forEach(cat => cat.style.display = 'block');

    const html = recentlyUsedVars.map(varName => {
        // Extract base variable name (remove braces and suffix)
        const cleanVarName = varName.replace(/[{}]/g, '');
        const baseVarName = cleanVarName.split('.')[0];
        const suffixClass = getSuffixClass(baseVarName);

        // Check if this variable has multiple suffixes
        const suffixes = window.variableSuffixMap?.[baseVarName] || ['base', 'next', 'last'];

        if (suffixes.length === 1) {
            // Single suffix: insert directly with displayed suffix
            return `<button type="button" class="chip ${suffixClass}" onclick="insertVariable('${varName}')">${cleanVarName}</button>`;
        } else {
            // Multiple suffixes: show popup selector
            return `<button type="button" class="chip ${suffixClass}" onclick="showSuffixSelector(event, '${baseVarName}')">${baseVarName}</button>`;
        }
    }).join('');

    containers.forEach(container => {
        container.innerHTML = html;
    });
}

// ============================================================================
// CONDITIONAL DESCRIPTIONS
// ============================================================================
function conditionsRender() {
    const container = document.getElementById('conditions-list');
    container.innerHTML = '';

    if (conditions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No conditions yet. Click "+ Add Condition" to get started.</p>';
        return;
    }

    // Sort conditions array by priority (lower number = higher priority = checked first)
    conditions.sort((a, b) => {
        const priorityA = parseInt(a.priority) || 50;
        const priorityB = parseInt(b.priority) || 50;
        return priorityA - priorityB;
    });

    conditions.forEach((condition, index) => {
        const card = document.createElement('div');
        card.className = 'condition-card';
        card.id = `cond-card-${index}`;

        const condType = condition.condition || '';
        const condSummary = getConditionSummaryText(condition);

        card.innerHTML = `
            <div class="condition-card-header" onclick="conditionsToggle(${index})">
                <div class="condition-card-title">
                    <div class="condition-card-name">${escapeHtml(condition.name || 'Condition ' + (index + 1))}</div>
                    <div class="condition-card-summary">${condSummary} ‚Ä¢ Priority: ${condition.priority || 50}</div>
                </div>
                <div class="condition-card-actions">
                    <button type="button" onclick="event.stopPropagation(); conditionsRemove(${index})" class="btn btn-sm btn-danger btn-icon" title="Delete">üóëÔ∏è</button>
                    <div class="condition-card-expand">‚ñº</div>
                </div>
            </div>
            <div class="condition-card-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="cond_name[]" value="${escapeHtml(condition.name || '')}">
                </div>
                <div class="form-group">
                    <label>Condition Type</label>
                    <select name="cond_type[]" onchange="updateConditionValueField(${index})">
                        <option value="">Select...</option>
                        <option value="away_loss_streak" ${condType === 'away_loss_streak' ? 'selected' : ''}>Away streak (loss) ‚â• N</option>
                        <option value="away_win_streak" ${condType === 'away_win_streak' ? 'selected' : ''}>Away streak (win) ‚â• N</option>
                        <option value="has_odds" ${condType === 'has_odds' ? 'selected' : ''}>Has odds</option>
                        <option value="home_loss_streak" ${condType === 'home_loss_streak' ? 'selected' : ''}>Home streak (loss) ‚â• N</option>
                        <option value="home_win_streak" ${condType === 'home_win_streak' ? 'selected' : ''}>Home streak (win) ‚â• N</option>
                        <option value="is_away" ${condType === 'is_away' ? 'selected' : ''}>Is away</option>
                        <option value="is_conference_game" ${condType === 'is_conference_game' ? 'selected' : ''}>Is conference game (college only)</option>
                        <option value="is_home" ${condType === 'is_home' ? 'selected' : ''}>Is home</option>
                        <option value="is_national_broadcast" ${condType === 'is_national_broadcast' ? 'selected' : ''}>Is national broadcast</option>
                        <option value="is_playoff" ${condType === 'is_playoff' ? 'selected' : ''}>Is playoff</option>
                        <option value="is_preseason" ${condType === 'is_preseason' ? 'selected' : ''}>Is preseason</option>
                        <option value="is_ranked_opponent" ${condType === 'is_ranked_opponent' ? 'selected' : ''}>Is ranked opponent (top 25)</option>
                        <option value="is_rematch" ${condType === 'is_rematch' ? 'selected' : ''}>Is rematch (same season)</option>
                        <option value="is_top_ten_matchup" ${condType === 'is_top_ten_matchup' ? 'selected' : ''}>Is top 10 matchup</option>
                        <option value="loss_streak" ${condType === 'loss_streak' ? 'selected' : ''}>Streak (loss) ‚â• N</option>
                        <option value="opponent_name_contains" ${condType === 'opponent_name_contains' ? 'selected' : ''}>Opponent name contains</option>
                        <option value="win_streak" ${condType === 'win_streak' ? 'selected' : ''}>Streak (win) ‚â• N</option>
                    </select>
                </div>
                <div class="form-group" id="cond-value-group-${index}">
                    <label>Value</label>
                    <input type="${condType === 'opponent_name_contains' ? 'text' : 'number'}" name="cond_value[]" id="cond_value_${index}" value="${condition.condition_value || ''}" placeholder="${condType === 'opponent_name_contains' ? 'e.g., Lakers' : 'e.g., 3'}">
                    <small class="help-text">${condType === 'opponent_name_contains' ? 'Text to match in opponent name (case-insensitive)' : 'For numerical conditions (streak length, etc.)'}</small>
                </div>
                <div class="form-group">
                    <label>Priority (1-100, lower = higher)</label>
                    <input type="number" name="cond_priority[]" min="1" max="100" value="${condition.priority || 50}">
                </div>
                <div class="form-group">
                    <label>Description Template</label>
                    <input type="text" name="cond_template[]" value="${escapeHtml(condition.template || '')}" class="template-field" id="cond_template_${index}">
                    <div class="inline-preview">
                        <small>Preview:</small>
                        <span id="preview-condition-${index}"></span>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); saveConditionToPreset(${index})">
                        üìö Save to Preset Library
                    </button>
                </div>
                <input type="hidden" name="cond_source[]" value="${condition.source || 'custom'}">
            </div>
        `;

        container.appendChild(card);
    });

    // Re-attach event listeners for template fields
    document.querySelectorAll('.template-field').forEach(field => {
        field.addEventListener('input', updatePreviews);
        field.addEventListener('focus', function() {
            lastTemplateField = this;
        });
    });

    // Update value field visibility for all conditions
    conditions.forEach((_, index) => {
        updateConditionValueField(index);
    });

    // Update previews for all conditional descriptions
    updatePreviews();
}

function getConditionSummaryText(condition) {
    const labels = {
        'away_loss_streak': `Away streak (loss) ‚â• ${condition.condition_value || 'N'}`,
        'away_win_streak': `Away streak (win) ‚â• ${condition.condition_value || 'N'}`,
        'has_odds': 'Has odds',
        'home_loss_streak': `Home streak (loss) ‚â• ${condition.condition_value || 'N'}`,
        'home_win_streak': `Home streak (win) ‚â• ${condition.condition_value || 'N'}`,
        'is_away': 'Is away',
        'is_conference_game': 'Is conference game (college only)',
        'is_home': 'Is home',
        'is_national_broadcast': 'Is national broadcast',
        'is_playoff': 'Is playoff',
        'is_preseason': 'Is preseason',
        'is_ranked_opponent': 'Is ranked opponent (top 25)',
        'is_rematch': 'Is rematch (same season)',
        'is_top_ten_matchup': 'Is top 10 matchup',
        'loss_streak': `Streak (loss) ‚â• ${condition.condition_value || 'N'}`,
        'opponent_name_contains': `Opponent name contains "${condition.condition_value || ''}"`,
        'win_streak': `Streak (win) ‚â• ${condition.condition_value || 'N'}`
    };
    return labels[condition.condition] || 'No condition selected';
}

function updateConditionValueField(index) {
    const select = document.querySelector(`select[name="cond_type[]"]:nth-of-type(${index + 1})`);
    const valueInput = document.getElementById(`cond_value_${index}`);
    const valueGroup = document.getElementById(`cond-value-group-${index}`);
    const helpText = valueGroup.querySelector('.help-text');

    if (!select || !valueInput) return;

    const condType = select.value;

    // Conditions that need a value
    const needsValue = ['win_streak', 'loss_streak', 'home_win_streak', 'home_loss_streak',
                       'away_win_streak', 'away_loss_streak', 'opponent_name_contains'];

    if (needsValue.includes(condType)) {
        valueGroup.style.display = 'block';
        if (condType === 'opponent_name_contains') {
            valueInput.type = 'text';
            valueInput.placeholder = 'e.g., Lakers';
            helpText.textContent = 'Text to match in opponent name (case-insensitive)';
        } else {
            valueInput.type = 'number';
            valueInput.placeholder = 'e.g., 3';
            helpText.textContent = 'For numerical conditions (streak length, etc.)';
        }
    } else {
        valueGroup.style.display = 'none';
    }
}

function conditionsToggle(index) {
    const card = document.getElementById(`cond-card-${index}`);
    if (card) {
        card.classList.toggle('expanded');
    }
}

function conditionsAddNew() {
    conditions.push({
        name: 'New Condition',
        condition: '',
        condition_value: '',
        priority: 50,
        template: '',
        source: 'custom'
    });
    conditionsRender();
}

function conditionsRemove(index) {
    if (confirm('Delete this condition?')) {
        conditions.splice(index, 1);
        conditionsRender();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// FALLBACK DESCRIPTIONS
// ============================================================================

function initFallbackDescriptions() {
    // Separate allDescriptions into fallbacks (priority 100) and conditions (priority 1-99)
    fallbacks = allDescriptions.filter(desc => desc.priority === 100);
    conditions = allDescriptions.filter(desc => desc.priority !== 100);

    // If no fallbacks exist, add one default with a label
    // Check template type to use appropriate default variables
    const hiddenInput = document.querySelector('input[name="template_type"][type="hidden"]');
    const radioInput = document.querySelector('input[name="template_type"]:checked');
    const templateType = hiddenInput?.value || radioInput?.value || 'team';

    if (fallbacks.length === 0) {
        if (templateType === 'event') {
            // Event templates use {away_team} and {home_team}
            fallbacks.push({
                label: 'Default',
                template: '{away_team} vs {home_team} at {venue}',
                priority: 100
            });
        } else {
            // Team templates use {team_name} and {opponent}
            fallbacks.push({
                label: 'Default',
                template: '{team_name} faces {opponent} at {venue}',
                priority: 100
            });
        }
    }

    renderFallbacks();
}

function initEventDescription() {
    // For event templates editing: populate event_description from first fallback
    // Check hidden input first (existing template), then radio button (new template)
    const hiddenInput = document.querySelector('input[name="template_type"][type="hidden"]');
    const radioInput = document.querySelector('input[name="template_type"]:checked');
    const templateType = hiddenInput?.value || radioInput?.value || 'team';
    const eventDescInput = document.getElementById('event_description');

    if (templateType === 'event' && eventDescInput) {
        if (fallbacks.length > 0) {
            // Use the first fallback's template as the event description
            eventDescInput.value = fallbacks[0].template || '';
        } else {
            // Default for event templates
            eventDescInput.value = '{away_team} vs {home_team} at {venue}';
        }
    }
}

function renderFallbacks() {
    const container = document.getElementById('fallback-descriptions-container');
    const countInput = document.getElementById('fallback-count');

    container.innerHTML = '';

    if (fallbacks.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No fallback descriptions yet. Click "+ Add Fallback Description" to get started.</p>';
        return;
    }

    fallbacks.forEach((fallback, index) => {
        const card = document.createElement('div');
        card.className = 'condition-card';  // Reuse condition card styling
        card.id = `fallback-card-${index}`;

        const labelText = fallback.label || 'Untitled Fallback';

        card.innerHTML = `
            <div class="condition-card-header" onclick="fallbacksToggle(${index})">
                <div class="condition-card-title">
                    <div class="condition-card-name">${escapeHtml(labelText)}</div>
                    <div class="condition-card-summary">Priority: 100 (Fallback)</div>
                </div>
                <div class="condition-card-actions">
                    ${fallbacks.length > 1 ? `<button type="button" onclick="event.stopPropagation(); removeFallbackDescription(${index})" class="btn btn-sm btn-danger btn-icon" title="Delete">üóëÔ∏è</button>` : ''}
                    <div class="condition-card-expand">‚ñº</div>
                </div>
            </div>
            <div class="condition-card-body">
                <div class="form-group">
                    <label>Label *</label>
                    <input type="text" name="fallback_label_${index}" value="${escapeHtml(fallback.label || '')}"
                           placeholder="e.g., 'Generic', 'Exciting', 'Classic'" required>
                </div>
                <div class="form-group">
                    <label>Description Template *</label>
                    <textarea name="fallback_template_${index}" rows="3" required class="template-field" id="fallback_template_${index}">${escapeHtml(fallback.template || '')}</textarea>
                    <div class="inline-preview">
                        <small>Preview:</small>
                        <span id="preview-fallback-${index}"></span>
                    </div>
                </div>
            </div>
        `;

        container.appendChild(card);
    });

    // Update hidden counter
    countInput.value = fallbacks.length;

    // Re-attach event listeners for template fields
    document.querySelectorAll('.template-field').forEach(field => {
        field.addEventListener('input', updatePreviews);
        field.addEventListener('focus', function() {
            lastTemplateField = this;
        });
    });

    // Update previews for all fallback descriptions
    updatePreviews();
}

function fallbacksToggle(index) {
    const card = document.getElementById(`fallback-card-${index}`);
    if (card) {
        card.classList.toggle('expanded');
    }
}

function addFallbackDescription() {
    const newNumber = fallbacks.length + 1;
    const label = newNumber === 1 ? 'Default' : `Default ${newNumber}`;

    fallbacks.push({
        label: label,
        template: '',
        priority: 100
    });
    renderFallbacks();

    // Auto-expand the newly added fallback
    const newIndex = fallbacks.length - 1;
    setTimeout(() => {
        const card = document.getElementById(`fallback-card-${newIndex}`);
        if (card) {
            card.classList.add('expanded');
        }
    }, 10);
}

function removeFallbackDescription(index) {
    if (fallbacks.length <= 1) {
        alert('You must have at least one fallback description.');
        return;
    }

    if (confirm('Delete this fallback description?')) {
        fallbacks.splice(index, 1);
        renderFallbacks();
    }
}

// ============================================================================
// PRESET LIBRARY
// ============================================================================
async function showPresetLibrary() {
    const modal = document.getElementById('presetModal');
    const list = document.getElementById('preset-library-list');

    try {
        const response = await fetch('/api/condition-presets');
        const presets = await response.json();

        list.innerHTML = '';
        if (presets.length === 0) {
            list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No presets available yet. Create conditions and save them as presets!</p>';
        } else {
            presets.forEach(preset => {
                const div = document.createElement('div');
                div.className = 'preset-item';
                div.innerHTML = `
                    <div class="preset-item-header">
                        <div class="preset-item-name">${escapeHtml(preset.name)}</div>
                        <div class="preset-item-actions">
                            <button class="preset-delete-btn" onclick="event.stopPropagation(); deletePreset(${preset.id})">Delete</button>
                        </div>
                    </div>
                    <div class="preset-item-condition">${getConditionSummaryText({condition: preset.condition_type, condition_value: preset.condition_value})} ‚Ä¢ Priority: ${preset.priority}</div>
                    <div class="preset-item-template">"${escapeHtml(preset.template)}"</div>
                `;
                div.onclick = () => addPresetToConditions(preset);
                list.appendChild(div);
            });
        }

        modal.classList.add('show');
    } catch (error) {
        console.error('Failed to load presets:', error);
        showNotification('Failed to load preset library', 'error');
    }
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('show');
}

function addPresetToConditions(preset) {
    conditions.push({
        name: preset.name,
        condition: preset.condition_type,
        condition_value: preset.condition_value,
        priority: preset.priority,
        template: preset.template,
        source: 'preset',
        preset_id: preset.id
    });
    conditionsRender();
    closePresetModal();
}

async function deletePreset(presetId) {
    if (!confirm('Delete this preset from the library? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/condition-presets/${presetId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showPresetLibrary();
            showNotification('Preset deleted successfully', 'success');
        } else {
            showNotification('Failed to delete preset', 'error');
        }
    } catch (error) {
        console.error('Failed to delete preset:', error);
        showNotification('Failed to delete preset', 'error');
    }
}

async function saveConditionToPreset(index) {
    // Read current values from form fields (not the stale conditions array)
    const nameInputs = document.querySelectorAll('input[name="cond_name[]"]');
    const typeSelects = document.querySelectorAll('select[name="cond_type[]"]');
    const valueInputs = document.querySelectorAll('input[name="cond_value[]"]');
    const priorityInputs = document.querySelectorAll('input[name="cond_priority[]"]');
    const templateInputs = document.querySelectorAll('input[name="cond_template[]"]');

    const conditionType = typeSelects[index]?.value || '';
    const conditionName = nameInputs[index]?.value || 'Custom Condition';
    const conditionValue = valueInputs[index]?.value || '';
    const conditionPriority = parseInt(priorityInputs[index]?.value) || 50;
    const conditionTemplate = templateInputs[index]?.value || '';

    if (!conditionType) {
        alert('Please select a condition type before saving to preset library.');
        return;
    }

    const description = prompt('Enter a description for this preset (optional):');
    if (description === null) return; // User cancelled

    try {
        const response = await fetch('/api/condition-presets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: conditionName,
                description: description || '',
                condition_type: conditionType,
                condition_value: conditionValue,
                priority: conditionPriority,
                template: conditionTemplate
            })
        });

        if (response.ok) {
            showNotification('Condition saved to preset library!', 'success');
        } else {
            const error = await response.json();
            showNotification(error.error || 'Failed to save preset', 'error');
        }
    } catch (error) {
        console.error('Failed to save preset:', error);
        showNotification('Failed to save preset', 'error');
    }
}

// ============================================================================
// FORM SUBMISSION
// ============================================================================
document.getElementById('template-form').addEventListener('submit', function(e) {
    // Get template type - check hidden input first (existing template), then radio button (new template)
    const hiddenInput = document.querySelector('input[name="template_type"][type="hidden"]');
    const radioInput = document.querySelector('input[name="template_type"]:checked');
    const templateType = hiddenInput?.value || radioInput?.value || 'team';
    let allDescriptions = [];

    if (templateType === 'event') {
        // Event templates: single description only, no fallbacks or conditions
        const eventDescInput = document.getElementById('event_description');
        const eventDescValue = eventDescInput?.value.trim() || '';

        if (!eventDescValue) {
            e.preventDefault();
            alert('A description is required.');
            return false;
        }

        // Store as a single description entry (no priority/fallback system)
        allDescriptions = [{
            priority: 100,
            template: eventDescValue,
            label: 'Default'
        }];
    } else {
        // Team templates: multiple fallbacks + conditional descriptions
        const fallbackCount = parseInt(document.getElementById('fallback-count').value) || 0;
        const serializedFallbacks = [];

        for (let i = 0; i < fallbackCount; i++) {
            const labelInput = document.querySelector(`input[name="fallback_label_${i}"]`);
            const templateInput = document.querySelector(`textarea[name="fallback_template_${i}"]`);

            if (templateInput && templateInput.value.trim()) {
                const label = labelInput?.value.trim() || '';
                if (!label) {
                    e.preventDefault();
                    alert('All fallback descriptions must have a label.');
                    return false;
                }
                serializedFallbacks.push({
                    priority: 100,
                    template: templateInput.value,
                    label: label
                });
            }
        }

        // Ensure at least one fallback exists for team templates
        if (serializedFallbacks.length === 0) {
            e.preventDefault();
            alert('At least one fallback description is required.');
            return false;
        }

        // Serialize conditional descriptions from form inputs
        const serializedConditions = conditions.map((cond, index) => {
            const nameInput = document.querySelectorAll('input[name="cond_name[]"]')[index];
            const typeSelect = document.querySelectorAll('select[name="cond_type[]"]')[index];
            const valueInput = document.querySelectorAll('input[name="cond_value[]"]')[index];
            const priorityInput = document.querySelectorAll('input[name="cond_priority[]"]')[index];
            const templateInput = document.querySelectorAll('input[name="cond_template[]"]')[index];
            const sourceInput = document.querySelectorAll('input[name="cond_source[]"]')[index];

            return {
                name: nameInput?.value || cond.name,
                condition: typeSelect?.value || cond.condition,
                condition_value: valueInput?.value || cond.condition_value,
                priority: parseInt(priorityInput?.value) || cond.priority,
                template: templateInput?.value || cond.template,
                source: sourceInput?.value || cond.source
            };
        });

        // Merge fallbacks + conditionals into single array
        allDescriptions = [...serializedFallbacks, ...serializedConditions];
    }

    const descriptionsJson = JSON.stringify(allDescriptions);

    // Update the existing hidden field for description_options
    const hiddenDescField = document.getElementById('description_options_field');
    if (hiddenDescField) {
        hiddenDescField.value = descriptionsJson;
    }

    // Build flags JSON from checkboxes
    const flags = {
        new: document.querySelector('input[name="include_new_tag"]')?.checked || false,
        live: document.querySelector('input[name="include_live_tag"]')?.checked || false,
        date: document.querySelector('input[name="include_date_tag"]')?.checked || false
    };
    const flagsJson = JSON.stringify(flags);

    // Update existing hidden field for flags
    const hiddenFlagsField = document.getElementById('flags_field');
    if (hiddenFlagsField) {
        hiddenFlagsField.value = flagsJson;
    }

    // Build categories JSON from checkboxes and custom input
    const categories = [];
    if (document.getElementById('category_sports')?.checked) {
        categories.push('Sports');
    }
    if (document.getElementById('category_sport_variable')?.checked) {
        categories.push('{sport}');
    }
    const customCategories = document.getElementById('categories_custom')?.value || '';
    if (customCategories.trim()) {
        const customCats = customCategories.split(',').map(c => c.trim()).filter(c => c);
        categories.push(...customCats);
    }
    const categoriesJson = JSON.stringify(categories);

    // Update existing hidden field for categories
    const hiddenCategoriesField = document.getElementById('categories_field');
    if (hiddenCategoriesField) {
        hiddenCategoriesField.value = categoriesJson;
    }
});
</script>
{% endblock %}
