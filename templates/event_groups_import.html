{% extends "base.html" %}

{% block title %}Import Event Groups - Teamarr{% endblock %}

{% block content %}
<style>
.import-layout {
    display: flex;
    gap: 0;
    height: calc(100vh - 4rem);
    overflow: hidden;
}

.accounts-sidebar {
    width: 240px;
    background: var(--bg-secondary);
    border-left: 2px solid var(--border);
    border-right: 2px solid var(--border);
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem 0;
    flex-shrink: 0;
    height: 100%;
}

.sidebar-header {
    padding: 0.5rem 0.75rem 0.75rem;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.5rem;
}

.account-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
    border-left: 3px solid transparent;
}

.account-item:hover {
    background: var(--bg-tertiary);
}

.account-item.active {
    background: var(--bg-tertiary);
    border-left-color: var(--primary);
}

.account-icon {
    font-size: 1.25rem;
}

.account-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.85rem;
    flex: 1;
}

.account-count {
    font-size: 0.75rem;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: 10px;
}

.main-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
    height: 100%;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border);
}

.content-title h1 {
    margin: 0;
    font-size: 1.5rem;
}

.search-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.search-input {
    flex: 1;
    padding: 0.625rem 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
}

.groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.5rem;
}

.group-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.5rem 0.625rem;
    cursor: pointer;
    transition: all 0.2s;
}

.group-card:hover:not(.enabled) {
    border-color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.group-card.selected {
    border-color: var(--success);
    background: var(--bg-tertiary);
}

.group-card.enabled {
    opacity: 0.7;
    cursor: default;
    border-color: var(--success);
}

.group-header {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.375rem;
}

.group-checkbox {
    margin-top: 0.125rem;
    width: 14px;
    height: 14px;
    cursor: pointer;
    flex-shrink: 0;
}

.group-card.enabled .group-checkbox {
    cursor: not-allowed;
}

.group-info {
    flex: 1;
    min-width: 0;
}

.group-name {
    font-weight: 600;
    font-size: 0.8125rem;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
    word-break: break-word;
    line-height: 1.2;
}

.group-id {
    font-size: 0.625rem;
    color: var(--text-muted);
}

.group-meta {
    display: flex;
    gap: 0.5rem;
    font-size: 0.6875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.enabled-badge {
    display: inline-block;
    background: var(--success);
    color: white;
    font-size: 0.5625rem;
    font-weight: 600;
    padding: 0.0625rem 0.25rem;
    border-radius: 2px;
    margin-left: 0.375rem;
    vertical-align: middle;
}

.group-actions {
    display: flex;
    gap: 0.375rem;
    margin-top: 0.375rem;
}

.group-actions .btn-sm {
    padding: 0.1875rem 0.5rem;
    font-size: 0.6875rem;
}

.import-actions {
    position: sticky;
    bottom: 0;
    background: var(--bg-primary);
    border-top: 2px solid var(--border);
    padding: 1rem 2rem;
    margin: 2rem -1.5rem 0 -1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.selection-count {
    color: var(--text-secondary);
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
}

.empty-state h3 {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.loading-spinner {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
}

.loading-spinner::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Configure Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--bg-tertiary);
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.375rem;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Preview Modal */
.modal-large {
    max-width: 900px;
}

.preview-summary {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.preview-table-container {
    max-height: 350px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
}

.preview-table thead {
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
}

.preview-table th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
}

.preview-table td {
    padding: 0.5rem 0.75rem;
    border-top: 1px solid var(--border);
    font-size: 0.8125rem;
}

.text-success { color: var(--success); }
.text-warning { color: var(--warning); }
.text-danger { color: var(--danger); }
.text-muted { color: var(--text-muted); }
</style>

<div class="import-layout">
    <!-- Left Sidebar with M3U Accounts -->
    <div class="accounts-sidebar" id="accounts-sidebar">
        <div class="sidebar-header">M3U Accounts</div>
        <div class="loading-spinner" id="accounts-loading">Loading accounts</div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Connection Error State -->
        <div id="connection-error" class="empty-state" style="display: none;">
            <h3>Dispatcharr Connection Error</h3>
            <p id="connection-error-msg">Could not connect to Dispatcharr.</p>
            <p>Please check your <a href="{{ url_for('settings_form') }}">Dispatcharr settings</a>.</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state">
            <h3>Select an M3U account</h3>
            <p>Choose an M3U account from the sidebar to view and import groups</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-spinner" style="display: none;">
            <p>Loading groups</p>
        </div>

        <!-- Groups Content -->
        <div id="groups-container" style="display: none;">
            <div class="content-header">
                <div class="content-title">
                    <h1 id="account-title">Groups</h1>
                    <small class="text-muted" id="groups-count">0 groups</small>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search groups by name..." oninput="filterGroups()">
                <button class="btn btn-secondary" onclick="loadGroups()">‚Üª Reload</button>
            </div>

            <div id="groups-grid" class="groups-grid"></div>
        </div>

        <!-- Import Actions (Sticky Footer) -->
        <div id="import-actions" class="import-actions" style="display: none;">
            <div class="selection-count">
                <span id="selected-count">0</span> group(s) selected
            </div>
            <div>
                <a href="{{ url_for('event_groups_list') }}" class="btn btn-secondary">Cancel</a>
                <button type="button" class="btn btn-success" onclick="showConfigureModal()" id="import-btn" disabled>
                    üì∫ Configure & Enable
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Configure Groups Modal -->
<div id="configure-modal" class="modal-overlay" onclick="closeConfigureModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Configure Event Groups</h2>
            <button class="modal-close" onclick="closeConfigureModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Configure <strong id="configure-count">0</strong> group(s) for event-based EPG generation.
            </p>

            <div class="form-group">
                <label for="config-sport">Sport *</label>
                <select id="config-sport" class="form-control" onchange="updateLeagueOptions()" required>
                    <option value="">Select sport...</option>
                    <option value="football">Football</option>
                    <option value="basketball">Basketball</option>
                    <option value="baseball">Baseball</option>
                    <option value="hockey">Hockey</option>
                    <option value="soccer">Soccer</option>
                </select>
            </div>

            <div class="form-group">
                <label for="config-league">League *</label>
                <select id="config-league" class="form-control" required>
                    <option value="">Select sport first...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="config-template">Event Template</label>
                <select id="config-template" class="form-control">
                    <option value="">Select a template...</option>
                    {% for template in event_templates %}
                    <option value="{{ template.id }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
                <small class="form-help">Required for EPG generation. Only event-type templates are shown.</small>
            </div>

            <hr style="border-color: var(--border); margin: 1rem 0;">
            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">Channel Number and Group</h4>

            <div class="form-group">
                <label for="config-channel-start">Channel Start Number</label>
                <input type="number" id="config-channel-start" class="form-control" placeholder="Auto-calculated if empty" min="1">
                <small class="form-help">First channel number for created channels. Leave empty to auto-assign next available range.</small>
            </div>

            <div class="form-group">
                <label for="config-channel-group">Channel Group</label>
                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                    <input type="text" id="config-group-filter" class="form-control" placeholder="Filter groups..." style="flex: 1;" oninput="filterChannelGroups()">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="toggleCreateGroupForm()">‚ûï New</button>
                </div>
                <div id="create-group-form" style="display: none; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="new-group-name" class="form-control" placeholder="New group name..." style="flex: 1;">
                        <button type="button" class="btn btn-sm btn-success" onclick="createGroupInline()">Create</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleCreateGroupForm()">‚úï</button>
                    </div>
                    <div id="create-group-status" style="margin-top: 0.25rem; font-size: 0.75rem;"></div>
                </div>
                <select id="config-channel-group" class="form-control" size="4" style="height: auto;">
                    <option value="">Loading groups...</option>
                </select>
                <small class="form-help">Dispatcharr group to assign created channels to. Only non-M3U groups shown.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeConfigureModal()">Cancel</button>
            <button class="btn btn-success" onclick="enableSelectedGroups()">Enable Group</button>
        </div>
    </div>
</div>

<!-- Stream Preview Modal -->
<div id="preview-modal" class="modal-overlay" onclick="closePreviewModal(event)">
    <div class="modal-content modal-large" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="preview-title">Stream Preview</h2>
            <button class="modal-close" onclick="closePreviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="preview-loading" class="loading-spinner">Loading streams</div>
            <div id="preview-content" style="display: none;">
                <div class="preview-summary">
                    <span id="preview-total">0 streams</span>
                </div>
                <div class="preview-table-container">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th style="width: 60%;">Stream Name</th>
                                <th style="width: 40%;">Stream ID</th>
                            </tr>
                        </thead>
                        <tbody id="preview-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
        </div>
    </div>
</div>

<script>
let accounts = [];
let groups = [];
let leagues = [];
let selectedGroups = new Set();
let enabledGroupIds = new Set();
let currentAccount = null;
let channelGroups = [];  // Dispatcharr channel groups for assignment
let nextChannelRange = 1001;  // Next available channel range (fallback)

// Load data on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadLeagues();
    await loadAccounts();
    await loadEnabledGroups();
    await loadChannelGroups();
    await loadNextChannelRange();
});

async function loadNextChannelRange() {
    try {
        const response = await fetch('/api/channel-lifecycle/next-channel-range');
        const data = await response.json();
        if (response.ok && data.next_channel_range) {
            nextChannelRange = data.next_channel_range;
            // Update placeholder to show the default
            const input = document.getElementById('config-channel-start');
            if (input) {
                input.placeholder = `Default: ${nextChannelRange}`;
            }
        }
    } catch (error) {
        console.error('Failed to load next channel range:', error);
    }
}

async function loadLeagues() {
    try {
        const response = await fetch('/api/leagues');
        const data = await response.json();
        leagues = data.leagues || [];
    } catch (error) {
        console.error('Failed to load leagues:', error);
    }
}

async function loadEnabledGroups() {
    try {
        const response = await fetch('/api/event-epg/groups');
        const data = await response.json();
        enabledGroupIds = new Set((data.groups || []).map(g => g.dispatcharr_group_id));
    } catch (error) {
        console.error('Failed to load enabled groups:', error);
    }
}

async function loadAccounts() {
    try {
        const response = await fetch('/api/event-epg/dispatcharr/accounts');
        const data = await response.json();

        if (!response.ok) {
            document.getElementById('accounts-loading').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('connection-error').style.display = 'block';
            document.getElementById('connection-error-msg').textContent = data.error || 'Connection failed';
            return;
        }

        accounts = data.accounts || [];
        renderAccountsSidebar();
    } catch (error) {
        console.error('Failed to load accounts:', error);
        document.getElementById('accounts-loading').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('connection-error').style.display = 'block';
        document.getElementById('connection-error-msg').textContent = error.message;
    }
}

function renderAccountsSidebar() {
    const sidebar = document.getElementById('accounts-sidebar');
    sidebar.innerHTML = '<div class="sidebar-header">M3U Accounts</div>';

    if (accounts.length === 0) {
        sidebar.innerHTML += '<div class="empty-state" style="padding: 1rem;"><p>No M3U accounts found</p></div>';
        return;
    }

    accounts.forEach(account => {
        const item = document.createElement('div');
        item.className = 'account-item';
        item.dataset.accountId = account.id;
        item.onclick = () => selectAccount(account);

        item.innerHTML = `
            <span class="account-icon">üì∫</span>
            <span class="account-name">${escapeHtml(account.name)}</span>
        `;

        sidebar.appendChild(item);
    });
}

async function selectAccount(account) {
    // Update active state
    document.querySelectorAll('.account-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`[data-account-id="${account.id}"]`)?.classList.add('active');

    currentAccount = account;
    selectedGroups.clear();

    // Show loading state
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('groups-container').style.display = 'none';
    document.getElementById('import-actions').style.display = 'none';
    document.getElementById('loading-state').style.display = 'block';

    await loadGroups();
}

async function loadGroups() {
    if (!currentAccount) return;

    const searchTerm = document.getElementById('search-input')?.value || '';

    try {
        let url = `/api/event-epg/dispatcharr/groups?account_id=${currentAccount.id}`;
        if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;

        const response = await fetch(url);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to load groups');
        }

        groups = data.groups || [];
        renderGroups();
    } catch (error) {
        console.error('Failed to load groups:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('groups-container').style.display = 'block';
        document.getElementById('groups-grid').innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <h3>Error loading groups</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderGroups() {
    const grid = document.getElementById('groups-grid');
    grid.innerHTML = '';

    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('account-title').textContent = currentAccount.name;
    document.getElementById('groups-count').textContent = `${groups.length} groups`;
    document.getElementById('groups-container').style.display = 'block';
    document.getElementById('import-actions').style.display = 'flex';

    if (groups.length === 0) {
        grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <h3>No groups found</h3>
                <p>Try adjusting your search or check this M3U account</p>
            </div>
        `;
        return;
    }

    groups.forEach(group => {
        const isEnabled = enabledGroupIds.has(group.id);
        const isSelected = selectedGroups.has(group.id);

        const card = document.createElement('div');
        card.className = 'group-card';
        if (isEnabled) card.classList.add('enabled');
        if (isSelected && !isEnabled) card.classList.add('selected');
        card.dataset.groupId = group.id;

        card.innerHTML = `
            <div class="group-header">
                <input type="checkbox" class="group-checkbox"
                       ${isSelected ? 'checked' : ''}
                       ${isEnabled ? 'disabled' : ''}
                       onclick="event.stopPropagation(); toggleGroup(${group.id})">
                <div class="group-info">
                    <div class="group-name">
                        ${escapeHtml(group.name)}
                        ${isEnabled ? '<span class="enabled-badge">ENABLED</span>' : ''}
                    </div>
                    <div class="group-id">ID: ${group.id}</div>
                </div>
            </div>
            <div class="group-meta">
                ${group.channel_count ? `<span>${group.channel_count} channels</span>` : ''}
                ${group.assigned_league ? `<span class="badge badge-primary">${group.assigned_league.toUpperCase()}</span>` : ''}
            </div>
            <div class="group-actions">
                <button onclick="event.stopPropagation(); previewGroup(${group.id}, '${escapeHtml(group.name)}')" class="btn btn-sm btn-secondary">
                    üëÅ Preview Streams
                </button>
            </div>
        `;

        if (!isEnabled) {
            card.onclick = function(e) {
                if (e.target.type !== 'checkbox' && !e.target.closest('button')) {
                    const checkbox = this.querySelector('.group-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleGroup(group.id);
                }
            };
        }

        grid.appendChild(card);
    });

    updateSelectionCount();
}

function filterGroups() {
    // Debounce search
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(loadGroups, 300);
}

function toggleGroup(groupId) {
    const card = document.querySelector(`[data-group-id="${groupId}"]`);
    if (card?.classList.contains('enabled')) return;

    if (selectedGroups.has(groupId)) {
        selectedGroups.delete(groupId);
        card?.classList.remove('selected');
    } else {
        selectedGroups.add(groupId);
        card?.classList.add('selected');
    }

    updateSelectionCount();
}

function updateSelectionCount() {
    const count = selectedGroups.size;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('import-btn').disabled = count === 0;
}

// Configure Modal
function showConfigureModal() {
    if (selectedGroups.size === 0) return;

    document.getElementById('configure-count').textContent = selectedGroups.size;
    document.getElementById('config-sport').value = '';
    document.getElementById('config-league').innerHTML = '<option value="">Select sport first...</option>';
    document.getElementById('config-template').value = '';
    document.getElementById('configure-modal').classList.add('active');
}

function closeConfigureModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('configure-modal').classList.remove('active');
}

function updateLeagueOptions() {
    const sport = document.getElementById('config-sport').value;
    const leagueSelect = document.getElementById('config-league');

    leagueSelect.innerHTML = '<option value="">Select league...</option>';

    if (!sport) return;

    const filteredLeagues = leagues.filter(l => l.sport === sport);
    filteredLeagues.forEach(league => {
        const option = document.createElement('option');
        option.value = league.code;
        option.textContent = league.name;
        leagueSelect.appendChild(option);
    });
}

// Channel Groups Management
async function loadChannelGroups() {
    try {
        const response = await fetch('/api/dispatcharr/channel-groups?exclude_m3u=true');
        const data = await response.json();

        if (response.ok) {
            channelGroups = data.groups || [];
            renderChannelGroupSelect();
        } else {
            console.error('Failed to load channel groups:', data.error);
            channelGroups = [];
            renderChannelGroupSelect();
        }
    } catch (error) {
        console.error('Failed to load channel groups:', error);
        channelGroups = [];
        renderChannelGroupSelect();
    }
}

function renderChannelGroupSelect(filter = '') {
    const select = document.getElementById('config-channel-group');
    if (!select) return;

    select.innerHTML = '<option value="">(No group - channels will be ungrouped)</option>';

    const filterLower = filter.toLowerCase();
    const filtered = channelGroups.filter(g =>
        !filter || g.name.toLowerCase().includes(filterLower)
    );

    filtered.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = `${group.name} (${group.channel_count || 0} channels)`;
        select.appendChild(option);
    });
}

function filterChannelGroups() {
    const filter = document.getElementById('config-group-filter').value;
    renderChannelGroupSelect(filter);
}

function toggleCreateGroupForm() {
    const form = document.getElementById('create-group-form');
    const isVisible = form.style.display !== 'none';
    form.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
        document.getElementById('new-group-name').value = '';
        document.getElementById('create-group-status').innerHTML = '';
        document.getElementById('new-group-name').focus();
    }
}

async function createGroupInline() {
    const groupName = document.getElementById('new-group-name').value.trim();
    const statusDiv = document.getElementById('create-group-status');

    if (!groupName) {
        statusDiv.innerHTML = '<span style="color: var(--danger);">Group name is required</span>';
        return;
    }

    statusDiv.innerHTML = '<span style="color: var(--text-muted);">Creating...</span>';

    try {
        const response = await fetch('/api/dispatcharr/channel-groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: groupName })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            statusDiv.innerHTML = '<span style="color: var(--success);">‚úì Created!</span>';

            // Reload groups and select the new one
            await loadChannelGroups();
            const select = document.getElementById('config-channel-group');
            const newOption = Array.from(select.options).find(opt => opt.value == data.group_id);
            if (newOption) {
                newOption.selected = true;
            }

            // Hide form after short delay
            setTimeout(() => {
                toggleCreateGroupForm();
            }, 500);
        } else {
            statusDiv.innerHTML = `<span style="color: var(--danger);">${data.error || 'Failed to create group'}</span>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<span style="color: var(--danger);">Error: ${error.message}</span>`;
    }
}

async function enableSelectedGroups() {
    const sport = document.getElementById('config-sport').value;
    const league = document.getElementById('config-league').value;
    const templateId = document.getElementById('config-template').value;
    const channelStart = document.getElementById('config-channel-start').value;
    const channelGroupId = document.getElementById('config-channel-group').value;

    if (!sport || !league) {
        alert('Please select sport and league');
        return;
    }

    let successCount = 0;
    let errorCount = 0;

    for (const groupId of selectedGroups) {
        const group = groups.find(g => g.id === groupId);
        if (!group) continue;

        const payload = {
            dispatcharr_group_id: groupId,
            dispatcharr_account_id: currentAccount.id,
            group_name: group.name,
            assigned_sport: sport,
            assigned_league: league,
            account_name: currentAccount.name
        };

        if (templateId) {
            payload.event_template_id = parseInt(templateId);
        }

        if (channelStart) {
            payload.channel_start = parseInt(channelStart);
        }

        if (channelGroupId) {
            payload.channel_group_id = parseInt(channelGroupId);
        }

        try {
            const response = await fetch('/api/event-epg/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                successCount++;
            } else {
                errorCount++;
            }
        } catch (error) {
            errorCount++;
        }
    }

    closeConfigureModal();

    if (successCount > 0) {
        alert(`‚úÖ Successfully enabled ${successCount} group(s)!${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} group(s) failed.` : ''}`);
        window.location.href = '{{ url_for("event_groups_list") }}';
    } else {
        alert(`‚ùå Failed to enable groups`);
    }
}

// Preview Modal
async function previewGroup(groupId, groupName) {
    document.getElementById('preview-title').textContent = `Preview: ${groupName}`;
    document.getElementById('preview-loading').style.display = 'block';
    document.getElementById('preview-content').style.display = 'none';
    document.getElementById('preview-modal').classList.add('active');

    try {
        const response = await fetch(`/api/event-epg/dispatcharr/groups/${groupId}/streams?limit=50`);
        const data = await response.json();

        document.getElementById('preview-loading').style.display = 'none';
        document.getElementById('preview-content').style.display = 'block';

        if (response.ok) {
            document.getElementById('preview-total').textContent = `${data.total_streams} streams (showing ${data.streams.length})`;

            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = '';

            data.streams.forEach(stream => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(stream.name)}">
                        ${escapeHtml(stream.name)}
                    </td>
                    <td class="text-muted">${stream.id || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            document.getElementById('preview-body').innerHTML =
                `<tr><td colspan="2" class="text-danger">Error: ${data.error}</td></tr>`;
        }
    } catch (error) {
        document.getElementById('preview-loading').style.display = 'none';
        document.getElementById('preview-content').style.display = 'block';
        document.getElementById('preview-body').innerHTML =
            `<tr><td colspan="2" class="text-danger">Error: ${error.message}</td></tr>`;
    }
}

function closePreviewModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('preview-modal').classList.remove('active');
}

// Utilities
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
