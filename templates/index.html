{% extends "base.html" %}

{% block title %}Dashboard - Teamarr{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div>
            <h1>Dashboard</h1>
            <p class="page-subtitle">Overview of your EPG system</p>
        </div>
        <div class="quick-actions">
            <span class="quick-actions-label">Quick Actions</span>
            <div class="quick-actions-buttons">
                <a href="{{ url_for('templates_add_form') }}" class="btn btn-secondary">üìù Create Template</a>
                <a href="{{ url_for('teams_import') }}" class="btn btn-secondary">üì• Import Teams</a>
                <a href="{{ url_for('event_groups_import') }}" class="btn btn-secondary">üì∫ Import Event Group</a>
                <button onclick="generateEPGWithProgress()" class="btn btn-success" id="generate-epg-btn">üöÄ Generate EPG</button>
            </div>
        </div>
    </div>

    <!-- 4 Quadrants Grid -->
    <div class="quadrants-grid">
        <!-- Teams Quadrant -->
        <div class="quadrant">
            <div class="quadrant-header">
                <h3>Teams</h3>
                <a href="{{ url_for('teams_list') }}" class="manage-link">Manage ‚Üí</a>
            </div>
            <div class="quadrant-tiles">
                <div class="tile">
                    <div class="tile-value">{{ team_count }}</div>
                    <div class="tile-label">Total</div>
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ team_league_count }}</div>
                    <div class="tile-label">Leagues</div>
                    {% if team_leagues %}
                    <div class="tile-tooltip">
                        <div class="tooltip-title">Leagues</div>
                        {% for league in team_leagues %}
                        <div class="tooltip-row tooltip-row-with-logo">
                            {% if league.logo_url %}
                            <img src="{{ league.logo_url }}" alt="{{ league.league_name }}" class="tooltip-league-logo">
                            {% endif %}
                            <span class="tooltip-name">{{ league.league_name }}</span>
                            <span class="tooltip-value">{{ league.team_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="tile">
                    <div class="tile-value">{{ active_team_count }}</div>
                    <div class="tile-label">Active</div>
                </div>
                <div class="tile">
                    <div class="tile-value">{{ assigned_team_count }}</div>
                    <div class="tile-label">Assigned</div>
                </div>
            </div>
        </div>

        <!-- Event Groups Quadrant -->
        <div class="quadrant">
            <div class="quadrant-header">
                <h3>Event Groups</h3>
                <a href="{{ url_for('event_groups_list') }}" class="manage-link">Manage ‚Üí</a>
            </div>
            <div class="quadrant-tiles">
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ event_group_count }}</div>
                    <div class="tile-label">Groups</div>
                    {% if event_groups_list %}
                    <div class="tile-tooltip tile-tooltip-wide">
                        <div class="tooltip-title">Event Groups</div>
                        {% for group in event_groups_list %}
                        <div class="tooltip-row">
                            <span class="tooltip-name tooltip-name-truncate">{{ group.group_name }}</span>
                            <span class="tooltip-value">{{ group.matched_count }}/{{ group.stream_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ event_leagues | length }}</div>
                    <div class="tile-label">Leagues</div>
                    {% if event_leagues %}
                    <div class="tile-tooltip">
                        <div class="tooltip-title">Leagues</div>
                        {% for league in event_leagues %}
                        <div class="tooltip-row tooltip-row-with-logo">
                            {% if league.logo_url %}
                            <img src="{{ league.logo_url }}" alt="{{ league.league_name }}" class="tooltip-league-logo">
                            {% endif %}
                            <span class="tooltip-name">{{ league.league_name }}</span>
                            <span class="tooltip-value">{{ league.group_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="tile">
                    <div class="tile-value">{{ total_event_streams }}</div>
                    <div class="tile-label">Streams</div>
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ matched_event_streams }}</div>
                    <div class="tile-label">Matched{% if total_event_streams > 0 %} <span class="tile-label-pct">({{ match_percent|int }}%)</span>{% endif %}</div>
                    {% if event_groups_list %}
                    <div class="tile-tooltip tile-tooltip-wide">
                        <div class="tooltip-title">Match Rate by Group</div>
                        {% for group in event_groups_list %}
                        {% set group_rate = ((group.matched_count or 0) / group.stream_count * 100)|round|int if group.stream_count else 0 %}
                        <div class="tooltip-row">
                            <span class="tooltip-name tooltip-name-truncate">{{ group.group_name }}</span>
                            <span class="tooltip-value">{{ group.matched_count }}/{{ group.stream_count }} ({{ group_rate }}%)</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- EPG Quadrant -->
        <div class="quadrant">
            <div class="quadrant-header">
                <h3>EPG</h3>
                <a href="{{ url_for('epg_management') }}" class="manage-link">Manage ‚Üí</a>
            </div>
            <div class="quadrant-tiles">
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ epg_stats.total_channels }}</div>
                    <div class="tile-label">Channels</div>
                    <div class="tile-tooltip">
                        <div class="tooltip-title">Breakdown</div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Team-based</span>
                            <span class="tooltip-value">{{ epg_stats.channels.team_based }}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Event-based</span>
                            <span class="tooltip-value">{{ epg_stats.channels.event_based }}</span>
                        </div>
                    </div>
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ epg_stats.events.total }}</div>
                    <div class="tile-label">Events</div>
                    <div class="tile-tooltip">
                        <div class="tooltip-title">Breakdown</div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Team-based</span>
                            <span class="tooltip-value">{{ epg_stats.events.team_based }}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Event-based</span>
                            <span class="tooltip-value">{{ epg_stats.events.event_based }}</span>
                        </div>
                    </div>
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ epg_stats.filler.total }}</div>
                    <div class="tile-label">Filler</div>
                    <div class="tile-tooltip">
                        <div class="tooltip-title">Breakdown</div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Pregame</span>
                            <span class="tooltip-value">{{ epg_stats.filler.pregame.total }}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Postgame</span>
                            <span class="tooltip-value">{{ epg_stats.filler.postgame.total }}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-name">Idle</span>
                            <span class="tooltip-value">{{ epg_stats.filler.idle.total }}</span>
                        </div>
                    </div>
                </div>
                <div class="tile">
                    <div class="tile-value">{{ epg_stats.total_programmes }}</div>
                    <div class="tile-label">Total</div>
                </div>
            </div>
        </div>

        <!-- Channels Quadrant -->
        <div class="quadrant">
            <div class="quadrant-header">
                <h3>Channels</h3>
                <a href="{{ url_for('channels_list') }}" class="manage-link">Manage ‚Üí</a>
            </div>
            <div class="quadrant-tiles">
                <div class="tile">
                    <div class="tile-value">{{ managed_channel_count }}</div>
                    <div class="tile-label">Active</div>
                </div>
                <div class="tile">
                    <div class="tile-value">{{ channels_with_logos }}</div>
                    <div class="tile-label">Logos</div>
                </div>
                <div class="tile tile-hoverable">
                    <div class="tile-value">{{ dispatcharr_groups_count }}</div>
                    <div class="tile-label">Groups</div>
                    {% if channel_groups_list %}
                    <div class="tile-tooltip tile-tooltip-wide">
                        <div class="tooltip-title">Channel Groups</div>
                        {% for group in channel_groups_list %}
                        <div class="tooltip-row">
                            <span class="tooltip-name tooltip-name-truncate">{{ group.channel_group_name }}</span>
                            <span class="tooltip-value">{{ group.channel_count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="tile">
                    <div class="tile-value">{{ recently_deleted_count }}</div>
                    <div class="tile-label">Deleted 24h</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EPG Generation History Table -->
    {% if epg_history %}
        <div class="section">
            <h2>EPG Generation History</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Generated At</th>
                            <th class="text-center">Channels</th>
                            <th class="text-center">Events</th>
                            <th class="text-center">Programs</th>
                            <th class="text-center">Duration</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in epg_history %}
                            <tr>
                                <td><span class="format-datetime" data-utc="{{ entry.generated_at }}">{{ entry.generated_at_formatted }}</span></td>
                                <td class="text-center">{{ entry.num_channels }}</td>
                                <td class="text-center">{{ entry.num_events }}</td>
                                <td class="text-center">{{ entry.num_programmes }}</td>
                                <td class="text-center">
                                    {% if entry.generation_time_seconds %}
                                        {% set secs = entry.generation_time_seconds|round|int %}
                                        {% if secs >= 60 %}
                                            {{ (secs // 60)|int }}m {{ (secs % 60)|int }}s
                                        {% else %}
                                            {{ secs }}s
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if entry.status == 'success' %}
                                        <span class="status-badge status-success">‚úì</span>
                                    {% elif entry.status == 'error' %}
                                        <span class="status-badge status-error">‚úó</span>
                                    {% elif entry.status == 'partial' %}
                                        <span class="status-badge status-warning">‚ö†</span>
                                    {% else %}
                                        <span class="status-badge">{{ entry.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <!-- Getting Started Guide -->
    {% if template_count == 0 and team_count == 0 %}
        <div class="section">
            <div class="info-box">
                <h3>Getting Started</h3>
                <ol class="getting-started">
                    <li><strong>Create a template</strong> - Define how your EPG programs will look</li>
                    <li><strong>Add teams</strong> - Add sports teams using their ESPN URLs</li>
                    <li><strong>Assign templates</strong> - Assign each team to a template</li>
                    <li><strong>Generate EPG</strong> - Click "Generate EPG" to create your XMLTV file</li>
                </ol>
            </div>
        </div>
    {% endif %}
</div>

<style>
.page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem 0;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.page-header h1 {
    margin: 0 0 0.25rem 0;
    font-size: 1.5rem;
    color: var(--text-primary);
}

.page-subtitle {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.quick-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
}

.quick-actions-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.quick-actions-buttons {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 6px;
}

/* Quadrants Grid */
.quadrants-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.quadrant {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
}

.quadrant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
}

.quadrant-header h3 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.quadrant-tiles {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.tile {
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 0.5rem;
    text-align: center;
    position: relative;
}

.tile-hoverable {
    cursor: help;
}

.tile-hoverable:hover {
    background: var(--bg-secondary);
}

.tile-tooltip {
    display: none;
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.5rem;
    min-width: 140px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    margin-top: 4px;
}

.tile-hoverable:hover .tile-tooltip {
    display: block;
}

.tooltip-title {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.375rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid var(--border);
}

.tooltip-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.125rem 0;
    font-size: 0.75rem;
}

.tooltip-name {
    color: var(--text-secondary);
}

.tooltip-value {
    color: var(--primary);
    font-weight: 600;
    min-width: 85px;
    text-align: right;
}

.tooltip-row-with-logo {
    gap: 0.5rem;
}

.tooltip-league-logo {
    width: 18px;
    height: 18px;
    object-fit: contain;
    flex-shrink: 0;
}

.tile-tooltip-wide {
    min-width: 200px;
    max-width: 280px;
}

.tooltip-name-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
}

.tile-label-pct {
    font-weight: 500;
    color: var(--text-secondary);
}

.tile-wide {
    grid-column: span 4;
}

.tile-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.tile-value-small {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary);
    line-height: 1.2;
}

.tile-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.manage-link {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-decoration: none;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    transition: color 0.2s, background-color 0.2s;
}

.manage-link:hover {
    color: var(--primary);
    background-color: rgba(59, 130, 246, 0.1);
}

/* Section */
.section {
    margin-bottom: 1.5rem;
}

.section h2 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.75rem 0;
    color: var(--text-primary);
}

/* Info Box */
.info-box {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid var(--primary);
    border-radius: 8px;
    padding: 1rem;
}

.info-box h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    color: var(--primary);
}

.getting-started {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 0.875rem;
}

.getting-started li {
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

/* History Table */
.table-container {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-secondary);
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
}

.history-table thead {
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
}

.history-table th {
    padding: 0.5rem 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
}

.history-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

.history-table tbody tr:last-child td {
    border-bottom: none;
}

.history-table tbody tr:hover {
    background: var(--bg-tertiary);
}

.text-center {
    text-align: center;
}

.status-badge {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 500;
}

.status-success {
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
}

.status-error {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
}

.status-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
}

/* Responsive */
@media (max-width: 768px) {
    .quadrants-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function showEPGUrl() {
    const url = window.location.origin + '/teamarr.xml';
    const message = `
        <strong>EPG URL for IPTV:</strong><br>
        <input type="text" value="${url}" readonly onclick="this.select()"
               style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px; font-family: monospace;">
        <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
            Click the URL to select it, then copy and paste into your IPTV app.
        </small>
    `;
    showNotification(message, 'info', 0, 'EPG URL');
}

// Format datetimes using global helper on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.format-datetime').forEach(el => {
        const utc = el.dataset.utc;
        if (utc && typeof formatDateTime === 'function') {
            el.textContent = formatDateTime(utc, { dateFormat: 'short' });
        }
    });
});
</script>
{% endblock %}
