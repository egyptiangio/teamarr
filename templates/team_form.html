{% extends "base.html" %}

{% block title %}{% if team %}Edit Team{% else %}Add Team{% endif %} - Teamarr{% endblock %}

{% block content %}
<style>
/* ============================================================================
   TABBED INTERFACE STYLES
   ============================================================================ */
.tabs-container {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border);
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.tab-button {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.2s;
}

.tab-button:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.tab-button.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ============================================================================
   STICKY SIDEBAR PREVIEW
   ============================================================================ */
.form-with-sidebar {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    align-items: start;
}

@media (max-width: 1200px) {
    .form-with-sidebar {
        grid-template-columns: 1fr;
    }
    .preview-sidebar {
        display: none;
    }
}

.preview-sidebar {
    position: sticky;
    top: 2rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
}

.preview-sidebar h4 {
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
    font-size: 1rem;
}

.preview-item {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-left: 3px solid var(--success);
    border-radius: 4px;
}

.preview-item strong {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
    text-transform: uppercase;
}

.preview-item span {
    color: var(--text-primary);
    word-wrap: break-word;
    display: block;
}

/* ============================================================================
   TEMPLATE COPY MODAL
   ============================================================================ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: var(--bg-primary);
    margin: auto;
    padding: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.team-select-list {
    margin-bottom: 1.5rem;
}

.team-select-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.team-select-item:hover {
    border-color: var(--primary);
    background: var(--bg-tertiary);
}

.team-select-item.selected {
    border-color: var(--primary);
    background: var(--primary-light, rgba(99, 102, 241, 0.1));
}

.field-checkboxes {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.field-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
}

.field-checkbox-label:hover {
    background: var(--bg-tertiary);
}

.field-checkbox-label input[type="checkbox"] {
    cursor: pointer;
}

/* ============================================================================
   CONDITIONAL DESCRIPTIONS - COLLAPSIBLE CARDS
   ============================================================================ */
.condition-card {
    border: 2px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    overflow: hidden;
    transition: all 0.2s;
}

.condition-card:hover {
    border-color: var(--primary-light, #818cf8);
}

.condition-card-header {
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
}

.condition-card-header:hover {
    background: var(--bg-secondary);
}

.condition-card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.condition-card-name {
    font-weight: 600;
    color: var(--text-primary);
}

.condition-card-summary {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.condition-card-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.condition-card-expand {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    transition: transform 0.2s;
}

.condition-card.expanded .condition-card-expand {
    transform: rotate(180deg);
}

.condition-card-body {
    padding: 1rem;
    display: none;
    border-top: 1px solid var(--border);
}

.condition-card.expanded .condition-card-body {
    display: block;
}

.condition-source-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.condition-source-custom {
    background: var(--primary-light, rgba(99, 102, 241, 0.1));
    color: var(--primary);
}

.condition-source-preset {
    background: var(--success-light, rgba(34, 197, 94, 0.1));
    color: var(--success);
}

/* ============================================================================
   PRESET LIBRARY MODAL
   ============================================================================ */
.preset-library-grid {
    display: grid;
    gap: 0.75rem;
}

.preset-item {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.preset-item:hover {
    border-color: var(--primary);
    background: var(--bg-tertiary);
}

.preset-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.preset-item-name {
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
}

.preset-item-actions {
    display: flex;
    gap: 0.5rem;
}

.preset-delete-btn {
    background: var(--danger, #ef4444);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.preset-delete-btn:hover {
    opacity: 0.8;
}

.preset-item-usage {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.preset-item-condition {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.preset-item-template {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
}

/* ============================================================================
   BUTTON STYLES
   ============================================================================ */
.btn-icon {
    padding: 0.5rem;
    min-width: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}

.chip {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.chip:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
</style>

<div class="card">
    <div class="card-header">
        <h2>{% if team %}Edit Team: {{ team.team_name }}{% else %}Add New Team{% endif %}</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button type="button" class="btn btn-secondary" onclick="showCopyModal()">üìã Copy Templates</button>
            <a href="{{ url_for('teams_list') }}" class="btn btn-secondary">‚Üê Back</a>
        </div>
    </div>

    <form method="POST" id="team-form">
        <div class="form-with-sidebar">
            <!-- MAIN FORM CONTENT -->
            <div>
                <!-- ESPN URL Import (New Teams Only) -->
                {% if not team %}
                <div class="form-group">
                    <label for="espn_url">ESPN Team URL *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="url" id="espn_url" placeholder="https://www.espn.com/nba/team/_/name/det/detroit-pistons" style="flex: 1;" required>
                        <button type="button" onclick="parseESPNUrl()" class="btn btn-primary">Load Team</button>
                    </div>
                    <small class="help-text">Find your team on ESPN.com, copy the URL, paste it here, and click "Load Team"</small>
                </div>
                <hr style="margin: 2rem 0;">
                {% endif %}

                <!-- Tabbed Navigation -->
                <div class="tabs-container">
                    <button type="button" class="tab-button active" data-tab="basic">üìã Basic Info</button>
                    <button type="button" class="tab-button" data-tab="templates">‚úèÔ∏è Templates</button>
                    <button type="button" class="tab-button" data-tab="conditions">üéØ Conditions</button>
                    <button type="button" class="tab-button" data-tab="fillers">üìÖ Fillers</button>
                </div>

                <!-- TAB 1: BASIC INFO -->
                <div class="tab-content active" id="tab-basic">
                    <fieldset>
                        <legend><h3>Team Information</h3></legend>

                        {% if team %}
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label>
                                <input type="checkbox" name="active" {% if team.active %}checked{% endif %}>
                                <strong>Active</strong> (include this team in EPG generation)
                            </label>
                        </div>
                        {% endif %}

                        <!-- ESPN Data (Read-Only) -->
                        <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; color: var(--text-secondary); font-size: 0.9rem;">üîí ESPN Team Data (Read-Only)</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted);">League</label>
                                    <div style="font-weight: 500;">{{ (team.league_name if team and team.league_name else team.league) if team else '' }}</div>
                                    <input type="hidden" name="league" id="league" value="{{ team.league if team else '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted);">Sport</label>
                                    <div style="font-weight: 500; text-transform: capitalize;">{{ team.sport if team else '' }}</div>
                                    <input type="hidden" name="sport" id="sport" value="{{ team.sport if team else '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted);">ESPN ID</label>
                                    <div style="font-weight: 500; font-family: monospace;">{{ team.espn_team_id if team else '' }}</div>
                                    <input type="hidden" name="espn_team_id" id="espn_team_id" value="{{ team.espn_team_id if team else '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted);">Team Name</label>
                                    <div style="font-weight: 500;">{{ team.team_name if team else '' }}</div>
                                    <input type="hidden" name="team_name" id="team_name" value="{{ team.team_name if team else '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted);">Abbreviation</label>
                                    <div style="font-weight: 500;">{{ team.team_abbrev if team else '' }}</div>
                                    <input type="hidden" name="team_abbrev" id="team_abbrev" value="{{ team.team_abbrev if team else '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="channel_id">XMLTV Channel ID *</label>
                            <input type="text" name="channel_id" id="channel_id" value="{{ team.channel_id if team else '' }}" required>
                            <small class="help-text">Default format: {slug}.{league}</small>
                        </div>

                        <div class="form-group">
                            <label for="game_duration">Game Duration (hours) *</label>
                            <input type="number" name="game_duration" id="game_duration" step="0.5" min="1" max="6" value="{{ team.game_duration if team else 6.0 }}" required>
                            <small class="help-text">NBA: 3.0, NFL: 3.5, Soccer: 2.0</small>
                        </div>

                        <div class="form-group">
                            <label for="categories">EPG Categories (comma-separated)</label>
                            <input type="text" name="categories" id="categories" value="{{ (team.categories | join(', ')) if team and team.categories is not none else '' }}">
                            <small class="help-text">Categories shown in EPG guide</small>
                        </div>

                        <div class="form-group">
                            <label for="categories_apply_to">Apply Categories To</label>
                            <select name="categories_apply_to" id="categories_apply_to">
                                <option value="all" {% if not team or team.categories_apply_to == 'all' %}selected{% endif %}>All Programs (Events + Filler)</option>
                                <option value="events" {% if team and team.categories_apply_to == 'events' %}selected{% endif %}>Events Only</option>
                            </select>
                            <small class="help-text">Choose whether categories apply to all programs or only game events</small>
                        </div>

                        <h4 style="margin: 1.5rem 0 0.5rem 0;">XMLTV Tags</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_date_tag" {% if team and team.flags and team.flags.date %}checked{% endif %}>
                                Include Date Tag
                            </label>
                            <small class="help-text">Adds &lt;date&gt; tag with program air date (YYYYMMDD format)</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_live_tag" {% if team and team.flags and team.flags.live %}checked{% endif %}>
                                Include Live Tag
                            </label>
                            <small class="help-text">Adds &lt;live/&gt; tag to scheduled game events</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="include_new_tag" {% if team and team.flags and team.flags.new %}checked{% endif %}>
                                Include New Tag
                            </label>
                            <small class="help-text">Adds &lt;new/&gt; tag to scheduled game events</small>
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 2: TEMPLATES -->
                <div class="tab-content" id="tab-templates">
                    <fieldset>
                        <legend><h3>Program Templates</h3></legend>

                        <!-- Variable Helper (Collapsible) -->
                        <div id="template-vars-templates"></div>
                        <div class="form-group">
                            <label for="title_format">Program Title Template *</label>
                            <input type="text" name="title_format" id="title_format" value="{{ team.title_format if team else '{team_name}' }}" required class="template-field">
                            <small class="help-text">Generic sport title. Example: "{team_name}" = "Pistons Basketball"</small>
                        </div>

                        <div class="form-group">
                            <label for="subtitle_template">Program Subtitle Template</label>
                            <input type="text" name="subtitle_template" id="subtitle_template" value="{{ team.subtitle_template if team else '{venue_full}' }}" class="template-field">
                            <small class="help-text">Matchup or venue. Example: "{team_abbrev} @ {opponent_abbrev}"</small>
                        </div>

                        <div class="form-group">
                            <label for="description_template">Program Description Template (Default)</label>
                            <input type="text" name="description_template" id="description_template" value="{{ team.description_template if team else '' }}" class="template-field">
                            <small class="help-text">Base description when no conditions match</small>
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 3: CONDITIONAL DESCRIPTIONS -->
                <div class="tab-content" id="tab-conditions">
                    <fieldset>
                        <legend><h3>üéØ Conditional Descriptions</h3></legend>

                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            Create dynamic descriptions based on team performance, rankings, and matchup context. Lower priority numbers are checked first.
                        </p>

                        <div style="background: var(--bg-secondary); border-left: 3px solid var(--info, #3b82f6); padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.85rem;">
                            <strong>How it works:</strong>
                            <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                                <li><strong>Priority:</strong> Lower = higher priority (1 checked before 50)</li>
                                <li><strong>Random selection:</strong> Multiple matches at same priority ‚Üí random pick</li>
                                <li><strong>Fallback:</strong> No matches ‚Üí default description used</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button type="button" class="btn btn-primary" onclick="conditionsAddNew()" type="button">+ Add Condition</button>
                            <button type="button" class="btn btn-secondary" onclick="showPresetLibrary()" type="button">üìö Preset Library</button>
                        </div>

                        <div id="conditions-list">
                            <!-- Conditions will be rendered here by JavaScript -->
                        </div>
                    </fieldset>
                </div>

                <!-- TAB 4: FILLER PROGRAMS -->
                <div class="tab-content" id="tab-fillers">
                    <fieldset>
                        <legend><h3>üìÖ EPG Filler Content</h3></legend>

                        <!-- Variable Helper (Collapsible) - Same as Templates tab -->
                        <div id="template-vars-fillers"></div>
                        <div class="form-group">
                            <label for="max_program_hours">Maximum Program Length (hours)</label>
                            <input type="number" name="max_program_hours" id="max_program_hours" min="1" max="24" value="{{ team.max_program_hours if team else 6 }}">
                            <small class="help-text">Long periods will be split into multiple entries</small>
                        </div>

                        <div class="form-group">
                            <label for="midnight_crossover_mode">Day After Game (if crosses midnight)</label>
                            <select name="midnight_crossover_mode" id="midnight_crossover_mode">
                                <option value="postgame" {% if not team or team.midnight_crossover_mode == 'postgame' %}selected{% endif %}>Postgame (continue coverage)</option>
                                <option value="idle" {% if team and team.midnight_crossover_mode == 'idle' %}selected{% endif %}>Idle (no-game day)</option>
                            </select>
                        </div>

                        <h4 style="margin: 1.5rem 0 0.5rem 0;">Pregame Content</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="pregame_enabled" id="pregame_enabled" {% if not team or team.pregame_enabled %}checked{% endif %}>
                                Enable Pregame EPG Entries
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="pregame_title">Pregame Title</label>
                            <input type="text" name="pregame_title" id="pregame_title" value="{{ team.pregame_title if team else 'Pregame Coverage' }}" class="template-field">
                        </div>
                        <div class="form-group">
                            <label for="pregame_description">Pregame Description</label>
                            <input type="text" name="pregame_description" id="pregame_description" value="{{ team.pregame_description if team else '{team_name} plays {opponent} today at {game_time}' }}" class="template-field">
                        </div>

                        <h4 style="margin: 1.5rem 0 0.5rem 0;">Postgame Content</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="postgame_enabled" id="postgame_enabled" {% if not team or team.postgame_enabled %}checked{% endif %}>
                                Enable Postgame EPG Entries
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="postgame_title">Postgame Title</label>
                            <input type="text" name="postgame_title" id="postgame_title" value="{{ team.postgame_title if team else 'Postgame Recap' }}" class="template-field">
                        </div>
                        <div class="form-group">
                            <label for="postgame_description">Postgame Description</label>
                            <input type="text" name="postgame_description" id="postgame_description" value="{{ team.postgame_description if team else '{team_name} {result_text} {opponent} - Final: {final_score}' }}" class="template-field">
                        </div>

                        <h4 style="margin: 1.5rem 0 0.5rem 0;">Idle Day Content</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="idle_enabled" id="idle_enabled" {% if not team or team.idle_enabled %}checked{% endif %}>
                                Enable Idle Day EPG Entries
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="idle_title">Idle Day Title</label>
                            <input type="text" name="idle_title" id="idle_title" value="{{ team.idle_title if team else '{team_name} Programming' }}" class="template-field">
                        </div>
                        <div class="form-group">
                            <label for="idle_description">Idle Day Description</label>
                            <input type="text" name="idle_description" id="idle_description" value="{{ team.idle_description if team else 'Next game: {next_date} at {next_time} vs {next_opponent}' }}" class="template-field">
                        </div>
                    </fieldset>
                </div>

                <!-- Form Actions -->
                <div class="form-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-success">üíæ Save Team</button>
                    <a href="{{ url_for('teams_list') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </div>

            <!-- STICKY SIDEBAR PREVIEW -->
            <div class="preview-sidebar">
                <h4>üì∫ Live Preview</h4>
                <div class="preview-item">
                    <strong>Title</strong>
                    <span id="sidebar-preview-title">{{ team.team_name if team else 'Team Name' }}</span>
                </div>
                <div class="preview-item">
                    <strong>Subtitle</strong>
                    <span id="sidebar-preview-subtitle">Kia Center, Orlando</span>
                </div>
                <div class="preview-item">
                    <strong>Description</strong>
                    <span id="sidebar-preview-description">Pistons (13-2) take on Magic (9-7) at Kia Center</span>
                </div>

                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Filler Programs</h4>
                <div class="preview-item">
                    <strong>Pregame</strong>
                    <span id="sidebar-preview-pregame">Pregame Coverage - Pistons play Magic today at 7:00 PM EST</span>
                </div>
                <div class="preview-item">
                    <strong>Postgame</strong>
                    <span id="sidebar-preview-postgame">Postgame Recap - Pistons defeated Heat - Final: 125-124</span>
                </div>
                <div class="preview-item">
                    <strong>Idle Day</strong>
                    <span id="sidebar-preview-idle">Pistons Programming - Next game: LA Clippers on November 25</span>
                </div>

                <small style="display: block; margin-top: 1rem; color: var(--text-muted); font-size: 0.8rem;">
                    Updates as you type using sample data
                </small>
            </div>
        </div>
    </form>
</div>

<!-- TEMPLATE COPY MODAL -->
<div id="copyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìã Copy Templates from Team</h3>
            <button type="button" class="modal-close" onclick="closeCopyModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="team-select-dropdown">Select Team to Copy From</label>
                <select id="team-select-dropdown" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-secondary); color: var(--text);">
                    <option value="">-- Select a team --</option>
                    <!-- Teams will be loaded here -->
                </select>
            </div>

            <h4>Select Fields to Copy</h4>
            <div style="margin-bottom: 1rem;">
                <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllFields(true)">Select All</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllFields(false)">Deselect All</button>
            </div>
            <div class="field-checkboxes" id="field-checkboxes">
                <label class="field-checkbox-label">
                    <input type="checkbox" value="title_format" checked> Title
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="subtitle_template" checked> Subtitle
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="description_template" checked> Description
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="description_options" checked> Conditions
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="pregame_title" checked> Pregame Title
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="pregame_description" checked> Pregame Description
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="postgame_title" checked> Postgame Title
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="postgame_description" checked> Postgame Description
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="idle_title" checked> Idle Day Title
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="idle_description" checked> Idle Day Description
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="include_new_tag" checked> New Tag
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="include_live_tag" checked> Live Tag
                </label>
                <label class="field-checkbox-label">
                    <input type="checkbox" value="include_date_tag" checked> Date Tag
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCopyModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="applyCopyTemplates()">Apply</button>
        </div>
    </div>
</div>

<!-- PRESET LIBRARY MODAL -->
<div id="presetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìö Condition Preset Library</h3>
            <button type="button" class="modal-close" onclick="closePresetModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-top: 0; color: var(--text-muted); font-size: 0.9rem;">
                Click a preset to add it to your conditions. You can modify and save your own presets below.
            </p>
            <div id="preset-library-list" class="preset-library-grid">
                <!-- Presets will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePresetModal()">Close</button>
        </div>
    </div>
</div>

<!-- Hidden inputs -->
<input type="hidden" name="team_logo_url" id="team_logo_url" value="{{ team.team_logo_url if team else '' }}">

{% endblock %}

{% block scripts %}
<script>
// ============================================================================
// GLOBAL STATE
// ============================================================================
let activeField = null;
let teamsCache = [];
// Conditions will be stored directly in the DOM as form inputs (no hidden field)
let conditions = {{ description_options_json | default('[]') | safe }};
let conditionCounter = 0;

// Sample data for preview - will be populated from API
let sampleData = {
    // Fallback: preserve team_name from template if available
    team_name: '{{ team.team_name if team else "Detroit Pistons" }}',
    team_abbrev: 'DET',
    team_record: '13-2',
    sport: 'Basketball',
    league: 'NBA',

    // Current Game (vs Orlando Magic)
    opponent: 'Orlando Magic',
    opponent_abbrev: 'ORL',
    opponent_record: '9-7',
    matchup: 'DET @ ORL',
    venue: 'Kia Center',
    venue_full: 'Kia Center, Orlando',
    game_time: '7:00 PM EST',
    game_date: 'November 23, 2025',

    // Team Stats
    win_streak: '11',
    loss_streak: '0',
    home_streak: '7-0 at home',
    away_streak: '5-0 on road',
    last_5_record: '5-0',
    last_10_record: '9-1',
    recent_form: 'WWWWW',
    playoff_seed: '1',
    games_back: '0.0',
    team_rank_formatted: '#1',
    team_ppg: '118.9',
    team_papg: '112.1',
    wins: '13',
    losses: '2',
    win_pct: '86.7',

    // Rosters and Player Stats
    head_coach: 'J.B. Bickerstaff',
    basketball_top_scorer_name: 'Cade Cunningham',
    basketball_top_scorer_ppg: '24.3',
    basketball_top_scorer_total: '365',
    basketball_top_scorer_position: 'G',
    basketball_top_rebounder_name: 'Jalen Duren',
    basketball_top_rebounder_rpg: '11.5',
    basketball_top_rebounder_total: '173',
    basketball_top_assist_name: 'Cade Cunningham',
    basketball_top_assist_apg: '9.2',
    basketball_top_assist_total: '138',
    football_quarterback_name: 'Jared Goff',
    football_quarterback_position: 'QB',
    football_quarterback_passing_yards: '2934',
    football_quarterback_passing_ypg: '244.5',
    football_top_rusher_name: 'Jahmyr Gibbs',
    football_top_rusher_position: 'RB',
    football_top_rusher_yards: '906',
    football_top_rusher_ypg: '75.5',
    football_top_receiver_name: 'Amon-Ra St. Brown',
    football_top_receiver_position: 'WR',
    football_top_receiver_yards: '889',
    football_top_receiver_ypg: '74.1',
    hockey_top_scorer_name: 'Dylan Larkin',
    hockey_top_scorer_position: 'C',
    hockey_top_scorer_goals: '12',
    hockey_top_scorer_gpg: '0.6',
    hockey_top_playmaker_name: 'Dylan Larkin',
    hockey_top_playmaker_position: 'C',
    hockey_top_playmaker_assists: '14',
    hockey_top_playmaker_apg: '0.7',
    baseball_top_hitter_name: 'Riley Greene',
    baseball_top_hitter_position: 'OF',
    baseball_top_hitter_avg: '.285',
    baseball_top_hitter_hits: '146',
    baseball_power_hitter_name: 'Spencer Torkelson',
    baseball_power_hitter_position: '1B',
    baseball_power_hitter_hrs: '26',
    baseball_power_hitter_hr_rate: '0.16',
    last_game_top_scorer_name: 'Cade Cunningham',
    last_game_top_scorer_points: '28',
    last_game_top_rebounder_name: 'Jalen Duren',
    last_game_top_rebounder_rebounds: '14',
    last_game_top_assist_name: 'Cade Cunningham',
    last_game_top_assist_assists: '11',
    last_game_passing_leader_name: 'Jared Goff',
    last_game_passing_leader_yards: '315',
    last_game_rushing_leader_name: 'Jahmyr Gibbs',
    last_game_rushing_leader_yards: '127',
    last_game_receiving_leader_name: 'Amon-Ra St. Brown',
    last_game_receiving_leader_yards: '156',

    // Next Game
    next_opponent: 'LA Clippers',
    next_opponent_record: '4-11',
    next_date: 'November 25, 2025',
    next_time: '8:00 PM EST',
    next_venue: 'Little Caesars Arena',
    next_matchup: 'LAC @ DET',

    // Last Game (vs Miami Heat)
    last_opponent: 'Miami Heat',
    last_opponent_record: '7-8',
    last_date: 'November 21, 2025',
    last_result: 'Win',
    last_score: '125-124',
    last_matchup: 'MIA @ DET',
    result_text: 'defeated',
    final_score: '125-124',
    final_record: '13-2',

    // Odds & Betting
    odds_provider: 'ESPN BET',
    over_under: '221.5',
    spread: '-3.5',
    odds_details: 'DET -3.5',
    moneyline: '-165',
    opponent_moneyline: '+140',
    spread_odds: '-110',
    opponent_spread_odds: '-110',
    spread_category: 'slight favorite',
    spread_category_text: 'as slight favorites',

    // Broadcast Information
    broadcast_simple: 'FanDuel SN DET',
    broadcast_network: 'FanDuel SN DET',
    broadcast_national_network: '',
    is_national_broadcast: 'false',

    // Game Summary
    game_summary: 'thriller',
    game_summary_text: 'in a thriller'
};

// ============================================================================
// TABBED INTERFACE
// ============================================================================
function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    console.log('initTabs called - found', tabButtons.length, 'buttons and', tabContents.length, 'content divs');

    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = this.dataset.tab;
            console.log('Tab clicked:', tabId);

            // Remove active class from all
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked
            this.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });
}

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', async function() {
    // Load variables from API first
    const loaded = await loadVariablesFromAPI();

    if (loaded) {
        // Merge API sample data with any existing sampleData
        sampleData = { ...sampleDataFromAPI, ...sampleData };
        console.log('‚úì Sample data updated from API');
    }

    initTabs();
    initTemplatePreview();
    renderConditions();  // Render conditions that were already initialized from template
    updateHiddenInput();  // Sync hidden field with conditions array
    loadTeamsList();

    // Update previews on input
    document.querySelectorAll('.template-field').forEach(field => {
        field.addEventListener('input', updatePreviews);
    });
});

// ============================================================================
// TEMPLATE PREVIEW
// ============================================================================
function initTemplatePreview() {
    updatePreviews();
}

function updatePreviews() {
    const title = document.getElementById('title_format')?.value || '';
    const subtitle = document.getElementById('subtitle_template')?.value || '';
    const description = document.getElementById('description_template')?.value || '';
    const pregameTitle = document.getElementById('pregame_title')?.value || '';
    const pregameDesc = document.getElementById('pregame_description')?.value || '';
    const postgameTitle = document.getElementById('postgame_title')?.value || '';
    const postgameDesc = document.getElementById('postgame_description')?.value || '';
    const idleTitle = document.getElementById('idle_title')?.value || '';
    const idleDesc = document.getElementById('idle_description')?.value || '';

    // Update main previews
    document.getElementById('sidebar-preview-title').textContent = replaceVariables(title) || 'Title';
    document.getElementById('sidebar-preview-subtitle').textContent = replaceVariables(subtitle) || 'Subtitle';
    document.getElementById('sidebar-preview-description').textContent = replaceVariables(description) || 'Description';

    // Update filler previews
    document.getElementById('sidebar-preview-pregame').textContent = replaceVariables(pregameTitle) + ' - ' + replaceVariables(pregameDesc);
    document.getElementById('sidebar-preview-postgame').textContent = replaceVariables(postgameTitle) + ' - ' + replaceVariables(postgameDesc);
    document.getElementById('sidebar-preview-idle').textContent = replaceVariables(idleTitle) + ' - ' + replaceVariables(idleDesc);
}

function replaceVariables(template) {
    let result = template;
    for (const [key, value] of Object.entries(sampleData)) {
        result = result.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
    }
    return result;
}

// Track last focused template field
let lastTemplateField = null;

// Track recently used variables (stored in localStorage)
let recentlyUsedVars = [];

// Load recently used variables from localStorage
function loadRecentlyUsed() {
    const stored = localStorage.getItem('teamarr_recent_vars');
    if (stored) {
        recentlyUsedVars = JSON.parse(stored);
        updateRecentlyUsedDisplay();
    }
}

// Add variable to recently used list
function addToRecentlyUsed(variable) {
    // Remove if already exists
    recentlyUsedVars = recentlyUsedVars.filter(v => v !== variable);
    // Add to beginning
    recentlyUsedVars.unshift(variable);
    // Keep only last 10
    recentlyUsedVars = recentlyUsedVars.slice(0, 10);
    // Save to localStorage
    localStorage.setItem('teamarr_recent_vars', JSON.stringify(recentlyUsedVars));
    // Update display
    updateRecentlyUsedDisplay();
}

// Update the recently used variables display
function updateRecentlyUsedDisplay() {
    const container = document.getElementById('recently-used-vars');
    const category = document.getElementById('recently-used-category');

    if (!container || recentlyUsedVars.length === 0) {
        if (category) category.style.display = 'none';
        return;
    }

    // Show the category
    if (category) category.style.display = 'block';

    // Clear and rebuild
    container.innerHTML = recentlyUsedVars.map(varName =>
        `<button type="button" class="chip" onclick="insertVariable('${varName}')">${varName.replace(/[{}]/g, '')}</button>`
    ).join('');
}

// Update last template field when user clicks into any template field
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.template-field, input[name^="description_options"], textarea[name*="template"], textarea[name*="description"], textarea[name*="title"]').forEach(field => {
        field.addEventListener('focus', function() {
            lastTemplateField = this;
        });
    });

    // Load recently used variables from localStorage
    const stored = localStorage.getItem('teamarr_recent_vars');
    if (stored) {
        recentlyUsedVars = JSON.parse(stored);
    }
});

function insertVariable(variable) {
    let targetElement = document.activeElement;

    // If no element is focused or it's not an input/textarea, use the last template field
    if (!targetElement || (targetElement.tagName !== 'INPUT' && targetElement.tagName !== 'TEXTAREA')) {
        targetElement = lastTemplateField;
    }

    // If still no target, try to find the description_template field as default
    if (!targetElement) {
        targetElement = document.getElementById('description_template');
    }

    if (targetElement && (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA')) {
        const start = targetElement.selectionStart || 0;
        const end = targetElement.selectionEnd || 0;
        const text = targetElement.value || '';
        const before = text.substring(0, start);
        const after = text.substring(end);
        targetElement.value = before + variable + after;
        targetElement.selectionStart = targetElement.selectionEnd = start + variable.length;
        targetElement.focus();
        lastTemplateField = targetElement;  // Update last used field

        // Track this variable as recently used
        addToRecentlyUsed(variable);

        updatePreviews();
    }
}

// ============================================================================
// TEMPLATE COPY MODAL
// ============================================================================
async function loadTeamsList() {
    try {
        const response = await fetch('/api/teams/list');
        teamsCache = await response.json();
    } catch (error) {
        console.error('Failed to load teams:', error);
    }
}

async function showCopyModal() {
    const modal = document.getElementById('copyModal');
    const dropdown = document.getElementById('team-select-dropdown');

    // Load teams if not already loaded or reload for fresh data
    if (!teamsCache || teamsCache.length === 0) {
        await loadTeamsList();
    }

    // Clear and populate dropdown (keep the first "Select a team" option)
    dropdown.innerHTML = '<option value="">-- Select a team --</option>';

    if (teamsCache && teamsCache.length > 0) {
        teamsCache.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = `${team.team_name} (${team.league_name || team.league})`;
            dropdown.appendChild(option);
        });
    } else {
        // Show message if no teams available
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No teams available';
        dropdown.appendChild(option);
    }

    modal.classList.add('show');
}

function closeCopyModal() {
    document.getElementById('copyModal').classList.remove('show');
}

function selectAllFields(checked) {
    document.querySelectorAll('#field-checkboxes input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
    });
}

async function applyCopyTemplates() {
    const dropdown = document.getElementById('team-select-dropdown');
    const selectedTeamId = dropdown.value;

    if (!selectedTeamId) {
        showNotification('Please select a team to copy from', 'error');
        return;
    }

    const selectedFields = Array.from(document.querySelectorAll('#field-checkboxes input[type="checkbox"]:checked'))
        .map(cb => cb.value);

    if (selectedFields.length === 0) {
        showNotification('Please select at least one field to copy', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/teams/${selectedTeamId}/templates`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const templates = await response.json();

        if (templates.error) {
            throw new Error(templates.error);
        }

        selectedFields.forEach(field => {
            if (field === 'description_options') {
                // Handle conditions separately
                if (templates.description_options) {
                    conditions = typeof templates.description_options === 'string'
                        ? JSON.parse(templates.description_options)
                        : templates.description_options;
                    renderConditions();
                }
            } else if (field === 'include_new_tag' || field === 'include_live_tag' || field === 'include_date_tag') {
                // Handle tag checkboxes from flags object
                const element = document.querySelector(`input[name="${field}"]`);
                if (element && templates.flags) {
                    const flagKey = field.replace('include_', '').replace('_tag', '');
                    element.checked = templates.flags[flagKey] || false;
                }
            } else {
                const element = document.getElementById(field);
                if (element && templates[field] !== undefined) {
                    element.value = templates[field];
                }
            }
        });

        updatePreviews();
        closeCopyModal();

        // Show success feedback
        showNotification('Templates copied! Click "Save Team" to apply changes.', 'success', 5000);
    } catch (error) {
        console.error('Failed to copy templates:', error);
        showNotification(`Failed to copy templates: ${error.message}`, 'error');
    }
}

// ============================================================================
// CONDITIONAL DESCRIPTIONS - COMPLETE REWRITE USING FORM ARRAYS
// ============================================================================
function conditionsRender() {
    const container = document.getElementById('conditions-list');
    container.innerHTML = '';

    if (conditions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No conditions yet. Click "+ Add Condition" to get started.</p>';
        return;
    }

    conditions.forEach((condition, index) => {
        const card = document.createElement('div');
        card.className = 'condition-card';
        card.id = `cond-card-${index}`;

        const condType = condition.condition || '';
        const condSummary = getConditionSummaryText(condition);

        card.innerHTML = `
            <div class="condition-card-header" onclick="conditionsToggle(${index})">
                <div class="condition-card-title">
                    <div class="condition-card-name">${condition.name || 'Condition ' + (index + 1)}</div>
                    <div class="condition-card-summary">${condSummary} ‚Ä¢ Priority: ${condition.priority || 50}</div>
                </div>
                <div class="condition-card-actions">
                    <button type="button" onclick="event.stopPropagation(); conditionsRemove(${index})" class="btn btn-sm btn-danger btn-icon" title="Delete">üóëÔ∏è</button>
                    <div class="condition-card-expand">‚ñº</div>
                </div>
            </div>
            <div class="condition-card-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="cond_name[]" value="${escapeHtml(condition.name || '')}">
                </div>
                <div class="form-group">
                    <label>Condition Type</label>
                    <select name="cond_type[]">
                        <option value="">Select...</option>
                        <option value="win_streak" ${condType === 'win_streak' ? 'selected' : ''}>Win Streak ‚â• N</option>
                        <option value="loss_streak" ${condType === 'loss_streak' ? 'selected' : ''}>Loss Streak ‚â• N</option>
                        <option value="team_rank" ${condType === 'team_rank' ? 'selected' : ''}>Team Rank ‚â§ N</option>
                        <option value="opponent_rank" ${condType === 'opponent_rank' ? 'selected' : ''}>Opponent Rank ‚â§ N</option>
                        <option value="is_home" ${condType === 'is_home' ? 'selected' : ''}>Is Home Game</option>
                        <option value="is_away" ${condType === 'is_away' ? 'selected' : ''}>Is Away Game</option>
                        <option value="has_odds" ${condType === 'has_odds' ? 'selected' : ''}>Has Odds</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Value (if needed)</label>
                    <input type="number" name="cond_value[]" value="${condition.condition_value || ''}">
                </div>
                <div class="form-group">
                    <label>Priority (1-100, lower = higher)</label>
                    <input type="number" name="cond_priority[]" min="1" max="100" value="${condition.priority || 50}">
                </div>
                <div class="form-group">
                    <label>Description Template</label>
                    <input type="text" name="cond_template[]" value="${escapeHtml(condition.template || '')}" class="template-field">
                </div>
                <input type="hidden" name="cond_source[]" value="${condition.source || 'custom'}">
            </div>
        `;

        container.appendChild(card);
    });
}

function getConditionSummaryText(condition) {
    const labels = {
        'win_streak': `Win Streak ‚â• ${condition.condition_value}`,
        'loss_streak': `Loss Streak ‚â• ${condition.condition_value}`,
        'team_rank': `Team Rank ‚â§ ${condition.condition_value}`,
        'opponent_rank': `Opponent Rank ‚â§ ${condition.condition_value}`,
        'is_home': 'Home Game',
        'is_away': 'Away Game',
        'has_odds': 'Has Odds'
    };
    return labels[condition.condition] || 'No condition selected';
}

function conditionsToggle(index) {
    const card = document.getElementById(`cond-card-${index}`);
    if (card) {
        card.classList.toggle('expanded');
    }
}

// Alias for old code that might call renderConditions
function renderConditions() {
    conditionsRender();
}

function conditionsAddNew() {
    conditions.push({
        name: 'New Condition',
        condition: '',
        condition_value: '',
        priority: 50,
        template: '{team_name} faces {opponent}',
        source: 'custom'
    });
    conditionsRender();
}

function conditionsRemove(index) {
    if (confirm('Delete this condition?')) {
        conditions.splice(index, 1);
        conditionsRender();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// PRESET LIBRARY
// ============================================================================
async function showPresetLibrary() {
    const modal = document.getElementById('presetModal');
    const list = document.getElementById('preset-library-list');

    try {
        const response = await fetch('/api/condition-presets');
        const presets = await response.json();

        list.innerHTML = '';
        if (presets.length === 0) {
            list.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No presets available yet. Create conditions and save them as presets!</p>';
        } else {
            presets.forEach(preset => {
                const div = document.createElement('div');
                div.className = 'preset-item';
                div.innerHTML = `
                    <div class="preset-item-header">
                        <div class="preset-item-name">${preset.name}</div>
                        <div class="preset-item-actions">
                            <button class="preset-delete-btn" onclick="event.stopPropagation(); deletePreset(${preset.id})">Delete</button>
                        </div>
                    </div>
                    <div class="preset-item-condition">${getConditionSummaryText({condition: preset.condition_type, condition_value: preset.condition_value})} ‚Ä¢ Priority: ${preset.priority}</div>
                    <div class="preset-item-template">"${preset.template}"</div>
                `;
                div.onclick = () => addPresetToConditions(preset);
                list.appendChild(div);
            });
        }

        modal.classList.add('show');
    } catch (error) {
        console.error('Failed to load presets:', error);
        showNotification('Failed to load preset library', 'error');
    }
}

function closePresetModal() {
    document.getElementById('presetModal').classList.remove('show');
}

function addPresetToConditions(preset) {
    conditions.push({
        name: preset.name,
        condition: preset.condition_type,
        condition_value: preset.condition_value,
        priority: preset.priority,
        template: preset.template,
        source: 'preset',
        preset_id: preset.id
    });
    renderConditions();
    updateHiddenInput();
    closePresetModal();
}

async function deletePreset(presetId) {
    if (!confirm('Delete this preset from the library? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/condition-presets/${presetId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Reload preset library
            showPresetLibrary();
            showNotification('Preset deleted successfully', 'success');
        } else {
            showNotification('Failed to delete preset', 'error');
        }
    } catch (error) {
        console.error('Failed to delete preset:', error);
        showNotification('Failed to delete preset', 'error');
    }
}

// ============================================================================
// ESPN URL PARSING
// ============================================================================
async function parseESPNUrl() {
    const url = document.getElementById('espn_url').value;
    if (!url) {
        showNotification('Please enter an ESPN team URL', 'error');
        return;
    }

    try {
        const response = await fetch('/api/parse-espn-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });

        const data = await response.json();

        if (data.error) {
            showNotification(`Error: ${data.error}`, 'error');
            return;
        }

        // Fill in form fields
        document.getElementById('league').value = data.league;
        document.getElementById('sport').value = data.sport;
        document.getElementById('espn_team_id').value = data.espn_team_id;
        document.getElementById('team_name').value = data.team_name;
        document.getElementById('team_abbrev').value = data.team_abbrev;
        document.getElementById('team_logo_url').value = data.team_logo_url;
        document.getElementById('channel_id').value = data.channel_id;

        // Update display
        const espnDataDiv = document.querySelector('[style*="background: var(--bg-tertiary)"]');
        if (espnDataDiv) {
            espnDataDiv.querySelectorAll('div[style*="font-weight: 500"]').forEach((el, idx) => {
                const values = [data.league_name || data.league, data.sport, data.espn_team_id, data.team_name, data.team_abbrev];
                if (values[idx]) el.textContent = values[idx];
            });
        }

        showNotification('Team loaded successfully!', 'success');
    } catch (error) {
        console.error('Failed to parse URL:', error);
        showNotification('Failed to load team from URL. Please try again.', 'error');
    }
}

// ============================================================================
// TEMPLATE VARIABLES GENERATION (Dynamically loaded from /api/variables)
// ============================================================================

// Variables loaded from JSON API - will be populated on page load
let TEMPLATE_VARIABLES = {};
let sampleDataFromAPI = {};

// Load variables from API
async function loadVariablesFromAPI() {
    console.log('[loadVariablesFromAPI] Starting...');
    try {
        console.log('[loadVariablesFromAPI] Fetching /api/variables...');
        const response = await fetch('/api/variables');
        console.log('[loadVariablesFromAPI] Response status:', response.status);

        if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        console.log('[loadVariablesFromAPI] Received data:', data.total_variables, 'variables');

        // Group variables by category
        const categoryMap = {};
        const sampleMap = {};

        data.variables.forEach(variable => {
            // Build category structure
            if (!categoryMap[variable.category]) {
                categoryMap[variable.category] = {
                    icon: variable.icon,
                    variables: []
                };
            }
            categoryMap[variable.category].variables.push(variable.name);

            // Build sample data map
            sampleMap[variable.name] = variable.example;
        });

        // Update global variables
        TEMPLATE_VARIABLES = categoryMap;
        sampleDataFromAPI = sampleMap;

        console.log(`‚úì Loaded ${data.total_variables} variables into ${Object.keys(categoryMap).length} categories`);
        console.log('[loadVariablesFromAPI] TEMPLATE_VARIABLES:', Object.keys(TEMPLATE_VARIABLES).slice(0, 3));
        return true;
    } catch (error) {
        console.error('‚ùå Failed to load variables from API:', error);
        // Fallback: keep empty objects, UI will fail gracefully
        return false;
    }
}

// Generate template variables HTML
function generateTemplateVariablesHTML(containerId) {
    let html = `
        <details class="variable-helper" style="margin-bottom: 1.5rem; background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
            <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">üìù Template Variables</summary>

            <input type="text" class="variable-search-input" placeholder="Search variables..." style="width: 100%; margin: 1rem 0; padding: 0.5rem;">

            <div class="variable-category recently-used-category" style="display: none;">
                <h4>üïí Recently Used</h4>
                <div class="recently-used-vars" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Recently used variables will be dynamically added here -->
                </div>
            </div>
    `;

    // Generate category details
    const categoryCount = Object.keys(TEMPLATE_VARIABLES).length;
    console.log(`[generateTemplateVariablesHTML] TEMPLATE_VARIABLES has ${categoryCount} categories`);

    if (categoryCount === 0) {
        html += `<p style="color: orange; margin: 1rem 0;">‚ö†Ô∏è Loading variables from API...</p>`;
    }

    for (const [categoryName, categoryData] of Object.entries(TEMPLATE_VARIABLES)) {
        html += `
            <details style="margin-top: ${categoryName === 'Game Basics' ? '1rem' : '0.5rem'};" class="variable-category">
                <summary style="cursor: pointer; font-weight: bold;">${categoryData.icon} ${categoryName}</summary>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
        `;

        categoryData.variables.forEach(varName => {
            html += `<button type="button" class="chip" onclick="insertVariable('{${varName}}')">${varName}</button>`;
        });

        html += `
                </div>
            </details>
        `;
    }

    html += `
            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                Click any variable to insert at cursor.
            </p>
        </details>
    `;

    return html;
}

// Populate all three template variable containers
function initializeTemplateVariables() {
    const containers = [
        'template-vars-templates',
        'template-vars-conditionals',
        'template-vars-fillers'
    ];

    containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = generateTemplateVariablesHTML(containerId);
        }
    });

    // Set up search functionality for all search inputs
    document.querySelectorAll('.variable-search-input').forEach(searchInput => {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const parent = e.target.closest('.variable-helper');
            const categories = parent.querySelectorAll('.variable-category');

            categories.forEach(category => {
                // Skip recently used category
                if (category.classList.contains('recently-used-category')) return;

                const buttons = category.querySelectorAll('.chip');
                let hasVisibleButtons = false;

                buttons.forEach(button => {
                    const variableName = button.textContent.toLowerCase();
                    if (variableName.includes(searchTerm)) {
                        button.style.display = '';
                        hasVisibleButtons = true;
                    } else {
                        button.style.display = 'none';
                    }
                });

                // Show/hide the entire category based on whether it has visible buttons
                if (searchTerm && hasVisibleButtons) {
                    category.setAttribute('open', '');
                    category.style.display = '';
                } else if (searchTerm && !hasVisibleButtons) {
                    category.style.display = 'none';
                } else {
                    category.style.display = '';
                    category.removeAttribute('open');
                }
            });
        });
    });

    // Update recently used displays in all containers
    updateAllRecentlyUsedDisplays();
}

// Update recently used variables display in all containers
function updateAllRecentlyUsedDisplays() {
    const containers = document.querySelectorAll('.recently-used-vars');
    const categories = document.querySelectorAll('.recently-used-category');

    if (recentlyUsedVars.length === 0) {
        categories.forEach(cat => cat.style.display = 'none');
        return;
    }

    // Show all categories
    categories.forEach(cat => cat.style.display = 'block');

    // Update all containers
    const html = recentlyUsedVars.map(varName =>
        `<button type="button" class="chip" onclick="insertVariable('${varName}')">${varName.replace(/[{}]/g, '')}</button>`
    ).join('');

    containers.forEach(container => {
        container.innerHTML = html;
    });
}

// Override the existing updateRecentlyUsedDisplay to use the new function
const originalUpdateRecentlyUsedDisplay = updateRecentlyUsedDisplay;
updateRecentlyUsedDisplay = function() {
    updateAllRecentlyUsedDisplays();
};

// Initialize template variables and conditions on page load
document.addEventListener('DOMContentLoaded', async function() {
    console.log('[DOMCONTENTLOADED] Event fired!');

    // Load variables from API first
    await loadVariablesFromAPI();

    // Then initialize template variables UI
    initializeTemplateVariables();

    // Initialize conditions from server data and render them
    conditionsRender();
});
</script>
{% endblock %}
